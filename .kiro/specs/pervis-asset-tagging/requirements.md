# 素材标签与向量搜索系统需求

## 概述

本文档定义 Pervis PRO 素材标签体系、向量搜索功能和关键帧处理的需求规格。

## 1. 标签层级体系

### 1.1 一级标签（必填，单选）

| 标签类型 | 字段名 | 可选值 | 说明 |
|---------|--------|--------|------|
| 场景类型 | `scene_type` | INT/EXT/INT-EXT | 室内/室外/混合 |
| 时间 | `time_of_day` | DAY/NIGHT/DAWN/DUSK/UNKNOWN | 白天/夜晚/黎明/黄昏/未知 |
| 镜头类型 | `shot_size` | ECU/CU/MCU/MS/MLS/LS/ELS | 大特写/特写/中近景/中景/中远景/远景/大远景 |

### 1.2 二级标签（必填，单选）

| 标签类型 | 字段名 | 可选值 | 说明 |
|---------|--------|--------|------|
| 镜头运动 | `camera_move` | STATIC/PAN/TILT/DOLLY/CRANE/HANDHELD/ZOOM | 静止/横摇/俯仰/推轨/升降/手持/变焦 |
| 动作类型 | `action_type` | FIGHT/CHASE/DIALOGUE/IDLE/RUN/FLY/TRANSFORM/SKILL | 打斗/追逐/对话/静态/奔跑/飞行/变身/技能 |
| 情绪基调 | `mood` | TENSE/SAD/HAPPY/CALM/HORROR/ROMANTIC/EPIC/NEUTRAL | 紧张/悲伤/欢乐/平静/恐怖/浪漫/热血/中性 |

### 1.3 三级标签（可选，多选）

| 标签类型 | 字段名 | 示例值 | 说明 |
|---------|--------|--------|------|
| 角色 | `characters` | ["炭治郎", "善逸"] | 出现的角色列表 |
| 道具 | `props` | ["刀", "枪", "车"] | 关键道具 |
| 特效 | `vfx` | ["火焰", "水流", "雷电", "爆炸"] | 视觉特效类型 |
| 环境 | `environment` | ["森林", "城市", "室内", "海边"] | 环境场景 |

### 1.4 四级标签（自由标签）

| 标签类型 | 字段名 | 说明 |
|---------|--------|------|
| 自由标签 | `free_tags` | 最多 10 个，用于补充描述 |
| 来源作品 | `source_work` | 素材来源的作品名称 |
| 描述摘要 | `summary` | 50 字以内的内容描述 |

## 2. 标签编码规范

### 2.1 标签 ID 格式

```
{level}_{category}_{value}
```

示例：
- `L1_SCENE_INT` - 一级标签，场景类型，室内
- `L2_ACTION_FIGHT` - 二级标签，动作类型，打斗
- `L3_CHAR_炭治郎` - 三级标签，角色，炭治郎

### 2.2 标签权重

| 层级 | 权重 | 说明 |
|------|------|------|
| 一级 | 1.0 | 基础匹配 |
| 二级 | 0.8 | 重要匹配 |
| 三级 | 0.6 | 辅助匹配 |
| 四级 | 0.4 | 补充匹配 |

## 3. 向量搜索需求

### 3.1 嵌入模型要求

| 需求 | 规格 |
|------|------|
| 模型类型 | 文本嵌入模型 |
| 向量维度 | 384-1024 维 |
| 支持语言 | 中文、英文 |
| 部署方式 | 本地部署（Ollama）或 API |

### 3.2 推荐模型

| 模型 | 维度 | 部署方式 | 优先级 |
|------|------|----------|--------|
| `nomic-embed-text` | 768 | Ollama 本地 | ⭐⭐⭐ |
| `bge-m3` | 1024 | Ollama 本地 | ⭐⭐⭐ |
| `text-embedding-3-small` | 1536 | OpenAI API | ⭐⭐ |

### 3.3 向量存储要求

| 需求 | 规格 |
|------|------|
| 存储方式 | 内存 + 持久化 |
| 索引类型 | HNSW 或 IVF_FLAT |
| 相似度度量 | 余弦相似度 |
| 支持容量 | 10 万+ 素材 |

### 3.4 搜索功能

| 功能 | 说明 |
|------|------|
| 精确搜索 | 基于标签的精确匹配 |
| 模糊搜索 | 基于向量的语义相似度搜索 |
| 混合搜索 | 标签 + 向量加权混合 |
| 过滤搜索 | 先标签过滤，再向量排序 |

## 4. 搜索召回策略

### 4.1 召回流程

```
用户查询 → 查询解析 → 标签匹配 → 向量搜索 → 结果融合 → 排序返回
```

### 4.2 混合搜索权重

```python
final_score = tag_weight * tag_score + vector_weight * vector_score
# 默认: tag_weight = 0.4, vector_weight = 0.6
```

### 4.3 召回数量

| 阶段 | 数量 |
|------|------|
| 标签召回 | Top 50 |
| 向量召回 | Top 50 |
| 融合后 | Top 20 |
| 返回用户 | Top 5 |

## 6. 关键帧提取需求

### 6.1 提取策略

| 策略 | 说明 | 适用场景 |
|------|------|----------|
| 场景变化 | 基于 PySceneDetect 检测场景切换点 | 默认策略 |
| 固定间隔 | 每 N 秒提取一帧 | 长镜头素材 |
| 动作峰值 | 基于运动强度提取关键帧 | 动作场景 |
| 混合策略 | 场景变化 + 固定间隔补充 | 推荐策略 |

### 6.2 关键帧数量

| 素材时长 | 最小帧数 | 最大帧数 | 说明 |
|----------|----------|----------|------|
| < 5 秒 | 1 | 3 | 短片段 |
| 5-30 秒 | 3 | 10 | 标准片段 |
| 30-120 秒 | 5 | 20 | 长片段 |
| > 120 秒 | 10 | 50 | 超长素材 |

### 6.3 关键帧存储格式

| 字段 | 类型 | 说明 |
|------|------|------|
| `frame_index` | int | 帧序号 |
| `timestamp` | float | 时间戳（秒） |
| `timecode` | str | 时间码（HH:MM:SS:FF） |
| `image_path` | str | 缩略图存储路径 |
| `image_size` | tuple | 图像尺寸 (width, height) |
| `scene_id` | int | 所属场景 ID |

### 6.4 关键帧元数据

| 字段 | 类型 | 说明 |
|------|------|------|
| `motion_score` | float | 运动强度 (0-1) |
| `brightness` | float | 亮度值 (0-255) |
| `contrast` | float | 对比度值 |
| `dominant_colors` | list | 主色调 RGB 列表 |
| `is_scene_start` | bool | 是否为场景起始帧 |

## 7. 视觉嵌入需求（CLIP）

> **⚠️ 功能状态说明（2025-12-27 更新）**
> 
> 视觉模型的定位已调整：
> - **启用功能**：视觉模型用于**标签生成**（识别人设、角色、场景特征）
> - **暂缓功能**：以图搜图功能暂不启用
> - **触发位置**：在剧本环节由 Script_Agent 调用，而非资产管理环节
> - **详见**：`pervis-project-wizard` spec 的 Requirement 5.1.8

### 7.1 CLIP 模型要求

| 需求 | 规格 |
|------|------|
| 模型类型 | CLIP 视觉-语言模型 |
| 向量维度 | 512-768 维 |
| 支持输入 | 图像 + 文本 |
| 部署方式 | 本地部署（Ollama/HuggingFace）|

### 7.2 推荐模型

| 模型 | 维度 | 部署方式 | 优先级 |
|------|------|----------|--------|
| `llava:7b` | 768 | Ollama 本地 | ⭐⭐⭐ |
| `clip-vit-base-patch32` | 512 | HuggingFace | ⭐⭐ |
| `clip-vit-large-patch14` | 768 | HuggingFace | ⭐⭐ |
| `chinese-clip` | 512 | HuggingFace | ⭐⭐⭐（中文） |

### 7.3 视觉嵌入功能

| 功能 | 说明 |
|------|------|
| 图像嵌入 | 将关键帧图像转换为向量 |
| 文本嵌入 | 将查询文本转换为向量（与图像同空间） |
| 跨模态搜索 | 用文本搜索图像，用图像搜索图像 |
| 批量处理 | 支持批量图像嵌入 |

### 7.4 视觉嵌入存储

| 需求 | 规格 |
|------|------|
| 存储方式 | 与文本嵌入分开存储 |
| 索引类型 | HNSW（推荐）或 IVF_FLAT |
| 关联关系 | 关键帧 ID → 视觉向量 |
| 支持容量 | 100 万+ 关键帧 |

## 8. 时间轴参考需求

### 8.1 帧坐标系统

| 字段 | 类型 | 说明 |
|------|------|------|
| `asset_id` | str | 素材 ID |
| `frame_index` | int | 帧序号（从 0 开始） |
| `timestamp_ms` | int | 毫秒时间戳 |
| `timecode` | str | SMPTE 时间码 |
| `fps` | float | 帧率 |

### 8.2 时间戳映射

```python
# 帧序号 → 时间戳
timestamp_ms = frame_index * (1000 / fps)

# 时间戳 → 帧序号
frame_index = int(timestamp_ms * fps / 1000)

# 时间戳 → 时间码
timecode = f"{hours:02d}:{minutes:02d}:{seconds:02d}:{frames:02d}"
```

### 8.3 粗剪时间轴参考

| 功能 | 说明 |
|------|------|
| 入点标记 | 记录选中关键帧的时间戳作为入点 |
| 出点标记 | 记录选中关键帧的时间戳作为出点 |
| 片段预览 | 基于入出点预览素材片段 |
| 时间轴插入 | 将入出点范围插入时间轴 |

### 8.4 搜索结果时间轴信息

搜索返回结果应包含：
- 匹配关键帧的时间戳
- 建议的入出点范围
- 所属场景的时间范围
- 缩略图预览

## 9. 验收标准

### 9.1 标签覆盖率

- 一级标签覆盖率 ≥ 95%
- 二级标签覆盖率 ≥ 80%
- 三级标签覆盖率 ≥ 50%

### 9.2 搜索准确率

- 精确搜索准确率 ≥ 90%
- 模糊搜索相关性 ≥ 70%
- 混合搜索 Top5 命中率 ≥ 80%

### 9.3 性能要求

- 单次搜索响应时间 < 500ms
- 批量索引速度 ≥ 100 文件/秒
- 向量生成速度 ≥ 10 文件/秒

### 9.4 关键帧提取要求

- 关键帧提取覆盖率 ≥ 95%
- 每个素材至少 1 个关键帧
- 关键帧时间戳精度 ≤ 100ms

### 9.5 视觉嵌入要求

- 视觉嵌入覆盖率 ≥ 90%
- 跨模态搜索相关性 ≥ 60%
- 图像嵌入速度 ≥ 5 帧/秒

