# Design Document: Pervis PRO é¡¹ç›®ç«‹é¡¹å‘å¯¼ç³»ç»Ÿ

## Overview

æœ¬è®¾è®¡æ–‡æ¡£æè¿° Pervis PRO é¡¹ç›®ç«‹é¡¹å‘å¯¼ç³»ç»Ÿçš„æ¶æ„è®¾è®¡ã€‚ç³»ç»Ÿé‡‡ç”¨ MVP ç®€åŒ–æ–¹æ¡ˆï¼Œå°† Agent åŠŸèƒ½ç›´æ¥é›†æˆåˆ° Pervis PRO åç«¯ï¼Œä¿ç•™ Agent æ¦‚å¿µå’ŒçŠ¶æ€æ˜¾ç¤ºã€‚

> **ğŸ“Š å®Œæ•´æµç¨‹å›¾ç¤º**ï¼šè¯¦è§ [agent-workflow-diagram.md](./agent-workflow-diagram.md)ï¼ŒåŒ…å« Mermaid å¯è§†åŒ–å›¾è¡¨ã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
1. å¼•å¯¼ç”¨æˆ·å®Œæˆé¡¹ç›®å»ºæ¡£ï¼Œæ”¯æŒå¤šæ–‡ä»¶æ‰¹é‡å¯¼å…¥å’Œæ™ºèƒ½åˆ†ç±»
2. è‡ªåŠ¨è§£æå‰§æœ¬å¹¶æå–é¡¹ç›®ä¿¡æ¯ï¼Œæ— éœ€é‡å¤ä¸Šä¼ 
3. ä½¿ç”¨ Agent ç”Ÿæˆç¼ºå¤±å†…å®¹ï¼ˆScript_Agentã€Art_Agentã€Market_Agentï¼‰
4. Director_Agent å…¨ç¨‹åªè¾“å‡ºå®¡æ ¸å»ºè®®ï¼Œéœ€ç”¨æˆ·ç¡®è®¤
5. PM_Agent ç”¨æˆ·å¯è§ï¼Œç®¡ç†ç‰ˆæœ¬å†å²å’Œæ–‡ä»¶å‘½å
6. System_Agent å¯¼å‡ºå‰æ ¡éªŒï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§
7. å¤„ç†ç´ æå¹¶ç”Ÿæˆæ ‡ç­¾ï¼Œä¸º Beatboard é˜¶æ®µå‡†å¤‡æ•°æ®

---

## âš ï¸ ç°æœ‰æ¡†æ¶é—®é¢˜åˆ†æï¼ˆ2025-12-25 è¯„ä¼°ï¼‰

### é—®é¢˜æ€»è§ˆ

| é—®é¢˜ç±»å‹ | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ |
|----------|----------|------|
| ä¸¤å¥—ä»£ç åº“ä¸ç»Ÿä¸€ | ğŸ”´ é«˜ | å¾…ä¿®å¤ |
| Agent æ—  LLM è°ƒç”¨ | ğŸ”´ é«˜ | å¾…ä¿®å¤ |
| Director_Agent ç¼ºå°‘é¡¹ç›®è®°å¿† | ğŸ”´ é«˜ | å¾…ä¿®å¤ |
| PM_Agent åŠŸèƒ½ä¸åŒ¹é… | ğŸŸ¡ ä¸­ | å¾…ä¿®å¤ |
| Storyboard_Agent ä¸å­˜åœ¨ | ğŸ”´ é«˜ | å¾…æ–°å»º |
| æ—  REST API æš´éœ² | ğŸ”´ é«˜ | å¾…ä¿®å¤ |
| ç´ æé¢„å¤„ç†ç®¡é“ä¸å­˜åœ¨ | ğŸ”´ é«˜ | å¾…æ–°å»º |

### é—®é¢˜è¯¦æƒ…

#### P0-1: ä¸¤å¥—ä»£ç åº“ä¸ç»Ÿä¸€

```
å½“å‰çŠ¶æ€:
â”œâ”€â”€ multi-agent-workflow/backend/app/agents/  â† Agent æ¶æ„ï¼ˆBaseAgentã€MessageBusï¼‰
â””â”€â”€ Pervis PRO/backend/services/              â† ä¸šåŠ¡æœåŠ¡ï¼ˆLLMProviderã€AssetProcessorï¼‰

é—®é¢˜: ä¸¤å¥—ä»£ç æ²¡æœ‰é›†æˆï¼ŒAgent æ— æ³•è°ƒç”¨ Pervis PRO çš„æœåŠ¡
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼šåˆ›å»ºç»Ÿä¸€çš„æœåŠ¡é€‚é…å±‚ï¼Œè®© Agent å¯ä»¥è°ƒç”¨ Pervis PRO çš„ LLMProvider

#### P0-2: Agent æ—  LLM è°ƒç”¨

ç°æœ‰ Agent å®ç°åªæœ‰æ•°æ®ç»“æ„ç®¡ç†ï¼Œæ²¡æœ‰çœŸæ­£çš„ AI èƒ½åŠ›ï¼š

```python
# script_agent.py - åªæ˜¯æ­£åˆ™è§£æï¼Œæ²¡æœ‰ LLM
async def parse_script(self, content: str):
    scene_match = SCENE_HEADING_PATTERN.match(line)  # çº¯æ­£åˆ™

# art_agent.py - åªæ˜¯æ•°æ®ç®¡ç†ï¼Œæ²¡æœ‰ AI æ ‡ç­¾ç”Ÿæˆ
async def create_character(self, name: str):
    # åªåˆ›å»ºæ•°æ®ç»“æ„

# market_agent.py - LLM è°ƒç”¨æ˜¯ Mock çš„
response_text = f"åˆ†æç»“æœ: {query}"  # æ¨¡æ‹Ÿå“åº”
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼šé›†æˆ `Pervis PRO/backend/services/llm_provider.py`

#### P0-3: Director_Agent ç¼ºå°‘é¡¹ç›®è®°å¿†

spec è¦æ±‚ï¼š
> Director_Agent å…·æœ‰é¡¹ç›®è®°å¿†ï¼ŒåŒ…æ‹¬é¡¹ç›®è§„æ ¼ã€è‰ºæœ¯é£æ ¼ã€å†å²ç‰ˆæœ¬

å½“å‰å®ç°åªæœ‰å†²çªè§£å†³ï¼Œæ²¡æœ‰ï¼š
- âŒ é¡¹ç›®ä¸Šä¸‹æ–‡ï¼ˆProjectContextï¼‰
- âŒ å†å²ç‰ˆæœ¬å¯¹æ¯”
- âŒ è‰ºæœ¯é£æ ¼ä¸€è‡´æ€§æ£€æŸ¥

#### P0-4: PM_Agent åŠŸèƒ½ä¸åŒ¹é…

spec è¦æ±‚ï¼šç‰ˆæœ¬ç®¡ç†ã€ç‰ˆæœ¬å‘½åï¼ˆè§’è‰²_å¼ ä¸‰_v1.jsonï¼‰

å½“å‰å®ç°ï¼šåªæœ‰é¡¹ç›®æ–‡ä»¶å¤¹ç®¡ç†å’Œå½’æ¡£ï¼Œæ²¡æœ‰ç‰ˆæœ¬åŠŸèƒ½

#### P0-5: Storyboard_Agent ä¸å­˜åœ¨

spec è¦æ±‚çš„æ ¸å¿ƒåŠŸèƒ½å®Œå…¨æ²¡æœ‰å®ç°ï¼š
- âŒ ç´ æå¬å›
- âŒ Top 5 å€™é€‰ç¼“å­˜
- âŒ ä¸æ»‘åˆ‡æ¢

#### P0-6: æ—  REST API æš´éœ²

```
spec è¦æ±‚:
POST /api/wizard/parse-script
POST /api/wizard/generate-content
POST /api/wizard/recall-assets

å½“å‰çŠ¶æ€: åªæœ‰ Agent å†…éƒ¨é€šä¿¡ï¼Œæ²¡æœ‰ FastAPI è·¯ç”±
```

#### P0-7: ç´ æé¢„å¤„ç†ç®¡é“ä¸å­˜åœ¨

spec è¦æ±‚ï¼š`ç´ æä¸Šä¼  â†’ PySceneDetect â†’ Gemini â†’ Milvus`

å½“å‰çŠ¶æ€ï¼šå®Œå…¨æ²¡æœ‰å®ç°

---

## ä¿®å¤è®¡åˆ’

### Phase 0-Fix: æ¡†æ¶ä¿®å¤ï¼ˆä¼˜å…ˆäºåŸ Phase 0ï¼‰

| ä»»åŠ¡ | å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|--------|
| åˆ›å»º LLM æœåŠ¡é€‚é…å±‚ | 1å¤© | P0 |
| Script_Agent é›†æˆ LLM | 1å¤© | P0 |
| Art_Agent é›†æˆ LLM | 1å¤© | P0 |
| Director_Agent æ·»åŠ é¡¹ç›®è®°å¿† | 1å¤© | P0 |
| PM_Agent é‡æ„ä¸ºç‰ˆæœ¬ç®¡ç† | 1å¤© | P1 |
| åˆ›å»º Storyboard_Agent | 2å¤© | P0 |
| åˆ›å»º REST API è·¯ç”±å±‚ | 2å¤© | P0 |

### ç®€åŒ–æ¶æ„æ–¹æ¡ˆï¼ˆMVP æ¨èï¼‰

è€ƒè™‘åˆ°æ—¶é—´æˆæœ¬ï¼ŒMVP é˜¶æ®µå»ºè®®**ç®€åŒ–æ¶æ„**ï¼š

```
åŸæ–¹æ¡ˆï¼ˆå¤æ‚ï¼‰:
å‰ç«¯ â†’ REST API â†’ AgentService â†’ Agent (MessageBus) â†’ LLM

ç®€åŒ–æ–¹æ¡ˆï¼ˆæ¨èï¼‰:
å‰ç«¯ â†’ REST API â†’ AgentService â†’ LLMProviderï¼ˆç›´æ¥è°ƒç”¨ï¼‰
                              â†“
                         æ•°æ®åº“å­˜å‚¨
```

**ç®€åŒ–ç†ç”±**ï¼š
1. MessageBus åœ¨å•æœºéƒ¨ç½²æ—¶å¢åŠ å¤æ‚åº¦ï¼Œæ”¶ç›Šæœ‰é™
2. Agent é—´åä½œå¯ä»¥ç”¨ç®€å•çš„å‡½æ•°è°ƒç”¨æ›¿ä»£
3. å…ˆè·‘é€šæ ¸å¿ƒæµç¨‹ï¼Œåç»­å†å‡çº§ä¸ºå®Œæ•´ Agent æ¶æ„

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Frontend (React)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ProjectWizard.tsx                                                   â”‚
â”‚  â”œâ”€â”€ WizardStep1_BasicInfo.tsx    (åŸºæœ¬ä¿¡æ¯)                        â”‚
â”‚  â”œâ”€â”€ WizardStep2_Script.tsx       (å‰§æœ¬å¯¼å…¥)                        â”‚
â”‚  â”œâ”€â”€ WizardStep3_Characters.tsx   (è§’è‰²è®¾å®š + è§†è§‰æ ‡ç­¾ç¡®è®¤)         â”‚
â”‚  â”œâ”€â”€ WizardStep4_Scenes.tsx       (åœºæ¬¡è§„åˆ’ + åœºæ™¯æ ‡ç­¾ç¡®è®¤)         â”‚
â”‚  â”œâ”€â”€ WizardStep5_References.tsx   (å‚è€ƒèµ„æ–™)                        â”‚
â”‚  â””â”€â”€ WizardStep6_Confirm.tsx      (ç¡®è®¤æäº¤)                        â”‚
â”‚                                                                      â”‚
â”‚  Components:                                                         â”‚
â”‚  â”œâ”€â”€ MissingContentDialog.tsx     (ç¼ºå¤±å†…å®¹å¤„ç†å¯¹è¯æ¡†)              â”‚
â”‚  â”œâ”€â”€ AgentStatusPanel.tsx         (Agent çŠ¶æ€é¢æ¿)                  â”‚
â”‚  â”œâ”€â”€ VisualTagConfirmPanel.tsx    (è§†è§‰æ ‡ç­¾ç¡®è®¤é¢æ¿) [æ–°å¢]         â”‚
â”‚  â””â”€â”€ ProjectPreview.tsx           (é¡¹ç›®é¢„è§ˆ)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ REST API
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Backend (FastAPI)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /api/wizard/                                                        â”‚
â”‚  â”œâ”€â”€ POST /parse-script         - Script_Agent è§£æå‰§æœ¬             â”‚
â”‚  â”œâ”€â”€ POST /generate-content     - Agent ç”Ÿæˆå†…å®¹                    â”‚
â”‚  â”œâ”€â”€ POST /process-assets       - Art_Agent å¤„ç†ç´ æ                â”‚
â”‚  â”œâ”€â”€ POST /analyze-images       - Script_Agent è§†è§‰åˆ†æ [æ–°å¢]      â”‚
â”‚  â”œâ”€â”€ GET  /draft/{id}/suggested-tags - è·å– AI ç”Ÿæˆçš„æ ‡ç­¾ [æ–°å¢]    â”‚
â”‚  â”œâ”€â”€ POST /draft/{id}/confirm-tags   - ç”¨æˆ·ç¡®è®¤æ ‡ç­¾ [æ–°å¢]          â”‚
â”‚  â”œâ”€â”€ POST /create-project       - åˆ›å»ºé¡¹ç›®                          â”‚
â”‚  â”œâ”€â”€ GET  /templates            - è·å–æ¨¡æ¿åˆ—è¡¨                      â”‚
â”‚  â””â”€â”€ GET  /task-status/{id}     - è·å– Agent ä»»åŠ¡çŠ¶æ€               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AgentService Layer                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AgentService                                                        â”‚
â”‚  â”œâ”€â”€ Script_Agent (ç¼–å‰§) - æ–°å¢è§†è§‰åˆ†æèƒ½åŠ›                         â”‚
â”‚  â”‚   â”œâ”€â”€ parse_script()         - å‰§æœ¬è§£æ                          â”‚
â”‚  â”‚   â”œâ”€â”€ generate_logline()     - Logline ç”Ÿæˆ                      â”‚
â”‚  â”‚   â”œâ”€â”€ generate_synopsis()    - Synopsis ç”Ÿæˆ                     â”‚
â”‚  â”‚   â”œâ”€â”€ generate_bio()         - äººç‰©å°ä¼ ç”Ÿæˆ                      â”‚
â”‚  â”‚   â”œâ”€â”€ estimate_duration()    - æ—¶é•¿ä¼°ç®—                          â”‚
â”‚  â”‚   â”œâ”€â”€ analyze_reference_images() - è§†è§‰åˆ†æ [æ–°å¢]               â”‚
â”‚  â”‚   â”œâ”€â”€ generate_character_visual_tags() - è§’è‰²è§†è§‰æ ‡ç­¾ [æ–°å¢]     â”‚
â”‚  â”‚   â””â”€â”€ generate_scene_visual_tags() - åœºæ™¯è§†è§‰æ ‡ç­¾ [æ–°å¢]         â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€â”€ Art_Agent (ç¾æœ¯)                                               â”‚
â”‚  â”‚   â”œâ”€â”€ classify_file()        - æ–‡ä»¶åˆ†ç±»                          â”‚
â”‚  â”‚   â”œâ”€â”€ extract_metadata()     - å…ƒæ•°æ®æå–                        â”‚
â”‚  â”‚   â”œâ”€â”€ generate_tags()        - æ ‡ç­¾ç”Ÿæˆ                          â”‚
â”‚  â”‚   â””â”€â”€ create_thumbnail()     - ç¼©ç•¥å›¾ç”Ÿæˆ                        â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€â”€ Director_Agent (å¯¼æ¼”) - æœ‰é¡¹ç›®è®°å¿†                             â”‚
â”‚  â”‚   â”œâ”€â”€ review_output()        - å®¡æ ¸å…¶ä»– Agent è¾“å‡º               â”‚
â”‚  â”‚   â”œâ”€â”€ check_consistency()    - æ£€æŸ¥ä¸é¡¹ç›®è§„æ ¼ä¸€è‡´æ€§              â”‚
â”‚  â”‚   â””â”€â”€ compare_versions()     - å¯¹æ¯”å†å²ç‰ˆæœ¬                      â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â””â”€â”€ PM_Agent (é¡¹ç›®åŠ©ç†) - ç”¨æˆ·å¯è§ï¼Œæ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯                   â”‚
â”‚      â”œâ”€â”€ get_project_context()  - è·å–é¡¹ç›®ä¸Šä¸‹æ–‡                    â”‚
â”‚      â”œâ”€â”€ record_version()       - è®°å½•ç‰ˆæœ¬                          â”‚
â”‚      â”œâ”€â”€ record_decision()      - è®°å½•ç”¨æˆ·å†³ç­–                      â”‚
â”‚      â””â”€â”€ generate_version_name()- ç”Ÿæˆç‰ˆæœ¬å‘½å                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Vision Model Service (è§†è§‰æ¨¡å‹æœåŠ¡)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ollama_vision.py                                                    â”‚
â”‚  â”œâ”€â”€ OllamaVisionProvider       - Ollama è§†è§‰æ¨¡å‹é€‚é…å™¨             â”‚
â”‚  â”‚   â”œâ”€â”€ analyze_image()        - åˆ†æå•å¼ å›¾åƒ                      â”‚
â”‚  â”‚   â”œâ”€â”€ batch_analyze()        - æ‰¹é‡åˆ†æå›¾åƒ                      â”‚
â”‚  â”‚   â””â”€â”€ check_availability()   - æ£€æŸ¥æ¨¡å‹å¯ç”¨æ€§                    â”‚
â”‚  â”‚                                                                   â”‚
â”‚  æ”¯æŒçš„æ¨¡å‹:                                                         â”‚
â”‚  â”œâ”€â”€ llava-llama3              - æ¨èï¼Œæ•ˆæœå¥½                       â”‚
â”‚  â”œâ”€â”€ llava                     - å¤‡é€‰                               â”‚
â”‚  â””â”€â”€ moondream                 - è½»é‡çº§å¤‡é€‰                         â”‚
â”‚                                                                   â”‚
â”‚  âš ï¸ è§†è§‰æ¨¡å‹æ˜¯å¿…é€‰ä¾èµ–ï¼Œå› ä¸º:                                       â”‚
â”‚  â”œâ”€â”€ å¯¼å…¥å†…å®¹æ˜¯å¤šæ¨¡æ€çš„ï¼ˆæ–‡æœ¬+å›¾åƒï¼‰                                â”‚
â”‚  â”œâ”€â”€ éœ€è¦æ ¹æ®äººè®¾å‚è€ƒç”Ÿæˆå¯¹åº”æ ‡ç­¾                                   â”‚
â”‚  â””â”€â”€ æ ‡ç­¾ç”¨äºåç»­çš„ç´ æå¬å›å’ŒåŒ¹é…                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Project Context (é¡¹ç›®ä¸Šä¸‹æ–‡)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PM_Agent ç®¡ç†çš„æ•°æ®ï¼š                                               â”‚
â”‚  â”œâ”€â”€ é¡¹ç›®è§„æ ¼ (æ—¶é•¿ã€ç”»å¹…ã€å¸§ç‡ã€åˆ†è¾¨ç‡)                            â”‚
â”‚  â”œâ”€â”€ è‰ºæœ¯é£æ ¼ (å·²ç¡®å®šçš„è§†è§‰é£æ ¼ã€å¯¹æ ‡é¡¹ç›®)                          â”‚
â”‚  â”œâ”€â”€ ç‰ˆæœ¬å†å² (æ¯æ¬¡ Agent ç”Ÿæˆçš„å†…å®¹ç‰ˆæœ¬)                           â”‚
â”‚  â””â”€â”€ ç”¨æˆ·å†³ç­– (æ¥å—/æ‹’ç»/ä¿®æ”¹çš„å†å²)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Script_Agent è§†è§‰åˆ†æèƒ½åŠ›ï¼ˆæ–°å¢ 2025-12-27ï¼‰

### è§†è§‰åˆ†ææµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Script_Agent è§†è§‰åˆ†ææµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  ç”¨æˆ·ä¸Šä¼ äººè®¾å›¾/å‚è€ƒå›¾                                              â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 1: å›¾åƒé¢„å¤„ç†                                          â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ éªŒè¯å›¾åƒæ ¼å¼ï¼ˆJPG/PNG/PSDï¼‰                             â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ ç”Ÿæˆç¼©ç•¥å›¾                                              â”‚   â”‚
â”‚  â”‚  â””â”€â”€ å…³è”åˆ°è§’è‰²/åœºæ™¯                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 2: è°ƒç”¨è§†è§‰æ¨¡å‹ (ollama_vision.py)                     â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ ä½¿ç”¨ llava-llama3 æ¨¡å‹                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å‘é€å›¾åƒ + æç¤ºè¯                                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€ è·å–ç»“æ„åŒ–æ ‡ç­¾                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 3: æ ‡ç­¾ç”Ÿæˆ                                            â”‚   â”‚
â”‚  â”‚  è§’è‰²æ ‡ç­¾:                                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å¤–è§‚æè¿°ï¼ˆå‘å‹ã€è‚¤è‰²ã€ä½“å‹ï¼‰                            â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æœè£…é£æ ¼ï¼ˆç°ä»£/å¤è£…/åˆ¶æœï¼‰                              â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ é…è‰²ï¼ˆä¸»è‰²è°ƒã€è¾…è‰²è°ƒï¼‰                                  â”‚   â”‚
â”‚  â”‚  â””â”€â”€ ç‰¹å¾é“å…·ï¼ˆæ­¦å™¨ã€é…é¥°ï¼‰                                  â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  åœºæ™¯æ ‡ç­¾:                                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ åœºæ™¯ç±»å‹ï¼ˆå®¤å†…/å®¤å¤–ï¼‰                                   â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æ—¶é—´ï¼ˆæ—¥/å¤œ/é»„æ˜/é»æ˜ï¼‰                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å…‰çº¿ï¼ˆè‡ªç„¶å…‰/äººå·¥å…‰/æ··åˆï¼‰                              â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æ°›å›´ï¼ˆæ¸©é¦¨/ç´§å¼ /ç¥ç§˜ï¼‰                                  â”‚   â”‚
â”‚  â”‚  â””â”€â”€ ç¯å¢ƒå…ƒç´ ï¼ˆå»ºç­‘/è‡ªç„¶/é“å…·ï¼‰                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 4: ç”¨æˆ·ç¡®è®¤                                            â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å±•ç¤ºåŸå›¾ä¸è¯†åˆ«æ ‡ç­¾çš„å¯¹åº”å…³ç³»                            â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æä¾›æ ‡ç­¾ç¼–è¾‘ç•Œé¢                                        â”‚   â”‚
â”‚  â”‚  â””â”€â”€ å…è®¸ç”¨æˆ·ä¿®æ”¹æˆ–è¡¥å……æ ‡ç­¾                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 5: æ ‡ç­¾æµè½¬åˆ°èµ„äº§ç®¡ç†                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å†™å…¥ asset_tags è¡¨                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æ›´æ–°å‘é‡ç´¢å¼•                                            â”‚   â”‚
â”‚  â”‚  â””â”€â”€ ç”¨äºåç»­ç´ æå¬å›                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§†è§‰æ ‡ç­¾æ•°æ®ç»“æ„

```python
@dataclass
class CharacterVisualTags:
    """è§’è‰²è§†è§‰æ ‡ç­¾"""
    character_id: str           # å…³è”çš„è§’è‰² ID
    image_path: str             # åŸå›¾è·¯å¾„
    
    # å¤–è§‚ç‰¹å¾
    appearance: Dict[str, str]  # å‘å‹ã€è‚¤è‰²ã€ä½“å‹ç­‰
    clothing_style: str         # æœè£…é£æ ¼
    color_palette: List[str]    # é…è‰²ï¼ˆRGB æˆ–é¢œè‰²åï¼‰
    accessories: List[str]      # é…é¥°/é“å…·
    
    # å…ƒæ•°æ®
    confidence: float           # è¯†åˆ«ç½®ä¿¡åº¦
    source: str                 # æ¥æºï¼ˆvision_modelï¼‰
    confirmed: bool             # æ˜¯å¦å·²ç¡®è®¤
    confirmed_at: datetime      # ç¡®è®¤æ—¶é—´


@dataclass
class SceneVisualTags:
    """åœºæ™¯è§†è§‰æ ‡ç­¾"""
    scene_id: str               # å…³è”çš„åœºæ™¯ ID
    image_path: str             # åŸå›¾è·¯å¾„
    
    # åœºæ™¯ç‰¹å¾
    scene_type: str             # å®¤å†…/å®¤å¤–
    time_of_day: str            # æ—¥/å¤œ/é»„æ˜/é»æ˜
    lighting: str               # å…‰çº¿ç±»å‹
    mood: str                   # æ°›å›´
    environment: List[str]      # ç¯å¢ƒå…ƒç´ 
    
    # å…ƒæ•°æ®
    confidence: float           # è¯†åˆ«ç½®ä¿¡åº¦
    source: str                 # æ¥æºï¼ˆvision_modelï¼‰
    confirmed: bool             # æ˜¯å¦å·²ç¡®è®¤
    confirmed_at: datetime      # ç¡®è®¤æ—¶é—´
```

### è§†è§‰åˆ†æ API

```python
# åˆ†æå‚è€ƒå›¾åƒ
POST /api/wizard/analyze-images
{
    "draft_id": "xxx",
    "images": [
        {
            "image_id": "img_001",
            "image_path": "/uploads/character_ref_001.jpg",
            "type": "character",  # character | scene
            "related_id": "char_001"  # å…³è”çš„è§’è‰²/åœºæ™¯ ID
        }
    ]
}

# å“åº”
{
    "task_id": "task_xxx",
    "status": "processing",
    "agent": "script_agent"
}

# è·å–ç”Ÿæˆçš„æ ‡ç­¾
GET /api/wizard/draft/{draft_id}/suggested-tags

# å“åº”
{
    "character_tags": [
        {
            "character_id": "char_001",
            "image_path": "/uploads/character_ref_001.jpg",
            "tags": {
                "appearance": {"hair": "é»‘è‰²é•¿å‘", "skin": "ç™½çš™", "build": "çº¤ç»†"},
                "clothing_style": "ç°ä»£ä¼‘é—²",
                "color_palette": ["#2C3E50", "#E74C3C", "#ECF0F1"],
                "accessories": ["çœ¼é•œ", "æ‰‹è¡¨"]
            },
            "confidence": 0.85,
            "confirmed": false
        }
    ],
    "scene_tags": [...]
}

# ç¡®è®¤æ ‡ç­¾
POST /api/wizard/draft/{draft_id}/confirm-tags
{
    "character_tags": [
        {
            "character_id": "char_001",
            "tags": {...},  # å¯èƒ½è¢«ç”¨æˆ·ä¿®æ”¹è¿‡
            "confirmed": true
        }
    ],
    "scene_tags": [...]
}

# å“åº”
{
    "success": true,
    "message": "æ ‡ç­¾å·²ç¡®è®¤å¹¶å†™å…¥èµ„äº§ç®¡ç†",
    "asset_ids": ["asset_001", "asset_002"]
}
```

## Director_Agent å®¡æ ¸æœºåˆ¶

### å®¡æ ¸æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Director_Agent å®¡æ ¸æµç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Script_Agent/Art_Agent ç”Ÿæˆå†…å®¹                                    â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 1: è§„åˆ™æ ¡éªŒ                                            â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å†…å®¹ä¸ä¸ºç©º                                              â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å­—æ•°åœ¨åˆç†èŒƒå›´å†…                                        â”‚   â”‚
â”‚  â”‚  â””â”€â”€ æ ¼å¼æ­£ç¡®                                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 2: é¡¹ç›®è§„æ ¼ä¸€è‡´æ€§æ£€æŸ¥ (ä» PM_Agent è·å–ä¸Šä¸‹æ–‡)         â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æ—¶é•¿æ˜¯å¦ç¬¦åˆé¡¹ç›®è®¾å®š                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ ç”»å¹…æ˜¯å¦ç¬¦åˆé¡¹ç›®è®¾å®š                                    â”‚   â”‚
â”‚  â”‚  â””â”€â”€ å¸§ç‡æ˜¯å¦ç¬¦åˆé¡¹ç›®è®¾å®š                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 3: è‰ºæœ¯é£æ ¼ä¸€è‡´æ€§æ£€æŸ¥                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æ˜¯å¦ç¬¦åˆå·²ç¡®å®šçš„è§†è§‰é£æ ¼                                â”‚   â”‚
â”‚  â”‚  â””â”€â”€ æ˜¯å¦ç¬¦åˆå¯¹æ ‡é¡¹ç›®çš„è°ƒæ€§                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 4: å†å²ç‰ˆæœ¬å¯¹æ¯” (ä» PM_Agent è·å–å†å²)                 â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æ˜¯å¦ä¸ä¹‹å‰è¢«å¦å†³çš„ç‰ˆæœ¬ç›¸ä¼¼                              â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æ˜¯å¦ä¸ç”¨æˆ·å·²ç¡®è®¤çš„å†…å®¹çŸ›ç›¾                              â”‚   â”‚
â”‚  â”‚  â””â”€â”€ é¿å…"æ”¹å›ç¬¬ä¸€ç‰ˆ"çš„é—®é¢˜                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 5: è¿”å›å®¡æ ¸ç»“æœ                                        â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å®¡æ ¸é€šè¿‡ â†’ è¿”å›ç»“æœç»™ç”¨æˆ·                               â”‚   â”‚
â”‚  â”‚  â””â”€â”€ å®¡æ ¸å»ºè®® â†’ è¿”å›ç»“æœ + æ”¹è¿›å»ºè®®                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Director_Agent å®ç°

```python
class DirectorAgent:
    """å¯¼æ¼” Agent - æœ‰é¡¹ç›®è®°å¿†ï¼Œå®¡æ ¸å…¶ä»– Agent çš„è¾“å‡º"""
    
    def __init__(self, llm_provider: LLMProvider, pm_agent: PMAgent):
        self.llm = llm_provider
        self.pm_agent = pm_agent
    
    async def review(self, result: Any, task_type: str, project_id: str) -> ReviewResult:
        """å®¡æ ¸ Agent è¾“å‡ºç»“æœ"""
        
        # 1. è·å–é¡¹ç›®ä¸Šä¸‹æ–‡
        context = await self.pm_agent.get_project_context(project_id)
        
        # 2. è§„åˆ™æ ¡éªŒ
        rule_check = self._check_rules(result, task_type)
        if not rule_check.passed:
            return ReviewResult(
                status="rejected",
                reason=rule_check.reason,
                suggestions=rule_check.suggestions
            )
        
        # 3. é¡¹ç›®è§„æ ¼ä¸€è‡´æ€§æ£€æŸ¥
        spec_check = self._check_project_specs(result, context.specs)
        
        # 4. è‰ºæœ¯é£æ ¼ä¸€è‡´æ€§æ£€æŸ¥
        style_check = await self._check_style_consistency(result, context.style)
        
        # 5. å†å²ç‰ˆæœ¬å¯¹æ¯”
        history_check = await self._compare_with_history(
            result, 
            context.version_history,
            context.user_decisions
        )
        
        # 6. ç»¼åˆè¯„ä¼°
        if spec_check.passed and style_check.passed and history_check.passed:
            return ReviewResult(
                status="approved",
                message="å®¡æ ¸é€šè¿‡"
            )
        else:
            return ReviewResult(
                status="suggestions",
                message="å®¡æ ¸é€šè¿‡ï¼Œä½†æœ‰æ”¹è¿›å»ºè®®",
                suggestions=self._merge_suggestions(spec_check, style_check, history_check)
            )
    
    def _check_rules(self, result: Any, task_type: str) -> RuleCheckResult:
        """è§„åˆ™æ ¡éªŒ"""
        # å†…å®¹ä¸ä¸ºç©º
        # å­—æ•°åœ¨åˆç†èŒƒå›´å†…
        # æ ¼å¼æ­£ç¡®
        pass
    
    def _check_project_specs(self, result: Any, specs: ProjectSpecs) -> CheckResult:
        """æ£€æŸ¥é¡¹ç›®è§„æ ¼ä¸€è‡´æ€§"""
        # æ—¶é•¿ã€ç”»å¹…ã€å¸§ç‡æ˜¯å¦ç¬¦åˆé¡¹ç›®è®¾å®š
        pass
    
    async def _check_style_consistency(self, result: Any, style: StyleContext) -> CheckResult:
        """æ£€æŸ¥è‰ºæœ¯é£æ ¼ä¸€è‡´æ€§ï¼ˆä½¿ç”¨ LLMï¼‰"""
        prompt = f"""
        è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹æ˜¯å¦ç¬¦åˆé¡¹ç›®çš„è‰ºæœ¯é£æ ¼ï¼š
        
        é¡¹ç›®é£æ ¼ï¼š{style.description}
        å¯¹æ ‡é¡¹ç›®ï¼š{style.reference_projects}
        
        å¾…æ£€æŸ¥å†…å®¹ï¼š{result}
        
        è¯·è¯„ä¼°ä¸€è‡´æ€§å¹¶ç»™å‡ºå»ºè®®ã€‚
        """
        pass
    
    async def _compare_with_history(
        self, 
        result: Any, 
        history: List[VersionRecord],
        decisions: List[UserDecision]
    ) -> CheckResult:
        """å¯¹æ¯”å†å²ç‰ˆæœ¬ï¼Œé¿å…æ”¹å›è¢«å¦å†³çš„ç‰ˆæœ¬"""
        # æ£€æŸ¥æ˜¯å¦ä¸ä¹‹å‰è¢«å¦å†³çš„ç‰ˆæœ¬ç›¸ä¼¼
        # æ£€æŸ¥æ˜¯å¦ä¸ç”¨æˆ·å·²ç¡®è®¤çš„å†…å®¹çŸ›ç›¾
        pass
```

### PM_Agent å®ç°ï¼ˆç”¨æˆ·å¯è§ï¼‰

```python
class PMAgent:
    """é¡¹ç›®åŠ©ç† - ç”¨æˆ·å¯è§ï¼Œæ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"""
    
    def __init__(self, db: Database):
        self.db = db
    
    async def get_project_context(self, project_id: str) -> ProjectContext:
        """è·å–é¡¹ç›®ä¸Šä¸‹æ–‡"""
        return ProjectContext(
            specs=await self._get_project_specs(project_id),
            style=await self._get_style_context(project_id),
            version_history=await self._get_version_history(project_id),
            user_decisions=await self._get_user_decisions(project_id)
        )
    
    async def record_version(
        self, 
        project_id: str, 
        content_type: str, 
        content: Any,
        agent: str
    ) -> str:
        """è®°å½•ç‰ˆæœ¬å¹¶è¿”å›ç‰ˆæœ¬å·"""
        # è·å–å½“å‰ç‰ˆæœ¬å·
        current_version = await self._get_latest_version(project_id, content_type)
        new_version = current_version + 1
        
        # ç”Ÿæˆç‰ˆæœ¬å‘½å
        version_name = self.generate_version_name(content_type, new_version)
        
        await self.db.insert("content_versions", {
            "project_id": project_id,
            "content_type": content_type,
            "content": content,
            "agent": agent,
            "version": new_version,
            "version_name": version_name,
            "created_at": datetime.now()
        })
        
        return version_name
    
    def generate_version_name(self, content_type: str, version: int, name: str = None) -> str:
        """ç”Ÿæˆç‰ˆæœ¬å‘½å
        
        æ ¼å¼: {å†…å®¹ç±»å‹}_{åç§°}_v{ç‰ˆæœ¬å·}.{æ‰©å±•å}
        ç¤ºä¾‹: è§’è‰²_å¼ ä¸‰_v1.json, åœºæ¬¡å¤§çº²_v2.json, Logline_v3.txt
        """
        if name:
            return f"{content_type}_{name}_v{version}"
        return f"{content_type}_v{version}"
    
    async def record_decision(
        self, 
        project_id: str, 
        version_id: str, 
        decision: str,  # accepted, rejected, modified
        user_feedback: str = None
    ):
        """è®°å½•ç”¨æˆ·å†³ç­–"""
        await self.db.insert("user_decisions", {
            "project_id": project_id,
            "version_id": version_id,
            "decision": decision,
            "feedback": user_feedback,
            "created_at": datetime.now()
        })
    
    async def get_version_display_info(self, project_id: str) -> VersionDisplayInfo:
        """è·å–ç‰ˆæœ¬æ˜¾ç¤ºä¿¡æ¯ï¼ˆç”¨äºå‰ç«¯å±•ç¤ºï¼‰"""
        versions = await self._get_version_history(project_id)
        decisions = await self._get_user_decisions(project_id)
        
        return VersionDisplayInfo(
            current_version=versions[-1].version if versions else 0,
            last_modified=versions[-1].created_at if versions else None,
            history=[
                {
                    "version": v.version,
                    "version_name": v.version_name,
                    "content_type": v.content_type,
                    "agent": v.agent,
                    "decision": self._get_decision_for_version(v.id, decisions),
                    "created_at": v.created_at
                }
                for v in versions
            ]
        )


@dataclass
class ProjectContext:
    """é¡¹ç›®ä¸Šä¸‹æ–‡"""
    specs: ProjectSpecs          # é¡¹ç›®è§„æ ¼
    style: StyleContext          # è‰ºæœ¯é£æ ¼
    version_history: List[VersionRecord]  # ç‰ˆæœ¬å†å²
    user_decisions: List[UserDecision]    # ç”¨æˆ·å†³ç­–


@dataclass
class ProjectSpecs:
    """é¡¹ç›®è§„æ ¼"""
    duration: int       # æ—¶é•¿ï¼ˆç§’ï¼‰
    aspect_ratio: str   # ç”»å¹…ï¼ˆå¦‚ 16:9ï¼‰
    frame_rate: int     # å¸§ç‡
    resolution: str     # åˆ†è¾¨ç‡ï¼ˆå¦‚ 1920x1080ï¼‰


@dataclass
class StyleContext:
    """è‰ºæœ¯é£æ ¼ä¸Šä¸‹æ–‡"""
    description: str              # é£æ ¼æè¿°
    reference_projects: List[str] # å¯¹æ ‡é¡¹ç›®
    color_palette: List[str]      # è‰²å½©å€¾å‘
    mood: str                     # æƒ…ç»ªåŸºè°ƒ
```


## Components and Interfaces

### 1. å‰ç«¯ç»„ä»¶

#### 1.1 ProjectWizard ä¸»ç»„ä»¶

```typescript
interface ProjectWizardProps {
  templateId?: string;  // å¯é€‰çš„æ¨¡æ¿ ID
  onComplete: (projectId: string) => void;
}

interface WizardState {
  currentStep: number;
  projectData: ProjectData;
  agentTasks: AgentTask[];
  completionPercentage: number;
}

interface ProjectData {
  // åŸºæœ¬ä¿¡æ¯
  title: string;
  type: 'short_film' | 'ad' | 'mv' | 'feature';
  duration: number;
  aspectRatio: string;
  frameRate: number;
  
  // å‰§æœ¬ç›¸å…³
  logline: string;
  synopsis: string;
  script: string;
  
  // è§’è‰²
  characters: Character[];
  
  // åœºæ¬¡
  scenes: Scene[];
  
  // å‚è€ƒèµ„æ–™
  references: Reference[];
  
  // åˆ¶ä½œä¿¡æ¯
  budget?: string;
  timeline?: string;
  teamSize?: number;
  
  // å…ƒæ•°æ®
  fieldStatus: Record<string, FieldStatus>;
}

type FieldStatus = 'empty' | 'user_input' | 'script_agent' | 'art_agent' | 'placeholder' | 'processing';

interface AgentTask {
  id: string;
  agentType: 'script_agent' | 'art_agent' | 'director_agent';
  taskType: 'parse_script' | 'generate_logline' | 'generate_synopsis' | 
            'generate_bio' | 'estimate_duration' | 'analyze_style' | 'review';
  status: 'pending' | 'working' | 'reviewing' | 'completed' | 'failed';
  progress: number;
  result?: any;
  error?: string;
}
```

#### 1.2 AgentStatusPanel ç»„ä»¶

```typescript
interface AgentStatusPanelProps {
  tasks: AgentTask[];
  onRetry: (taskId: string) => void;
}

// æ˜¾ç¤ºç¤ºä¾‹ï¼š
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  ğŸ–Šï¸ ç¼–å‰§ Agent æ­£åœ¨å·¥ä½œ...          â”‚
// â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 40%           â”‚
// â”‚                                      â”‚
// â”‚  â†’ ä¸‹ä¸€æ­¥ï¼šå¯¼æ¼” Agent å®¡æ ¸          â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.3 MissingContentDialog ç»„ä»¶

```typescript
interface MissingContentDialogProps {
  isOpen: boolean;
  onClose: () => void;
  missingFields: MissingField[];
  onAction: (fieldId: string, action: ContentAction) => void;
  onBatchAction: (action: ContentAction) => void;
}

interface MissingField {
  id: string;
  name: string;
  description: string;
  responsibleAgent: 'script_agent' | 'art_agent';  // è´Ÿè´£ç”Ÿæˆçš„ Agent
}

type ContentAction = 'placeholder' | 'agent_generate' | 'manual_input';
```

### 2. åç«¯ API æ¥å£

#### 2.1 å‰§æœ¬è§£æ API

```python
# POST /api/wizard/parse-script
class ParseScriptRequest(BaseModel):
    content: str  # å‰§æœ¬æ–‡æœ¬å†…å®¹
    format: str = "txt"  # txt, pdf, docx, fdx

class ParseScriptResponse(BaseModel):
    task_id: str
    status: str
    agent: str = "script_agent"

# ä»»åŠ¡çŠ¶æ€å“åº”
class AgentTaskStatus(BaseModel):
    task_id: str
    agent_type: str  # script_agent, art_agent, director_agent
    task_type: str
    status: str  # pending, working, reviewing, completed, failed
    progress: int
    current_step: str  # "ç¼–å‰§ Agent æ­£åœ¨å·¥ä½œ...", "å¯¼æ¼” Agent å®¡æ ¸ä¸­..."
    result: Optional[Dict] = None
    error: Optional[str] = None
```

#### 2.2 Agent å†…å®¹ç”Ÿæˆ API

```python
# POST /api/wizard/generate-content
class GenerateContentRequest(BaseModel):
    type: str  # logline, synopsis, bio, duration, style
    context: Dict[str, Any]  # ä¸Šä¸‹æ–‡ä¿¡æ¯
    
class GenerateContentResponse(BaseModel):
    task_id: str
    status: str
    agent: str  # è´Ÿè´£çš„ Agent

# Agent å·¥ä½œæµç¨‹ï¼š
# 1. Script_Agent/Art_Agent æ‰§è¡Œä»»åŠ¡
# 2. Director_Agent å®¡æ ¸
# 3. è¿”å›ç»“æœ
```

#### 2.3 ç´ æå¤„ç† API

```python
# POST /api/wizard/process-assets
class ProcessAssetsRequest(BaseModel):
    asset_ids: List[str]
    
class ProcessAssetsResponse(BaseModel):
    task_id: str
    status: str
    agent: str = "art_agent"
```

### 3. AgentService æœåŠ¡å±‚

```python
class AgentService:
    """Agent æœåŠ¡å±‚ - ç®¡ç† Agent å·¥ä½œæµç¨‹"""
    
    def __init__(self, llm_provider: LLMProvider):
        self.llm = llm_provider
        self.script_agent = ScriptAgent(llm_provider)
        self.art_agent = ArtAgent(llm_provider)
        self.director_agent = DirectorAgent(llm_provider)
    
    async def execute_task(self, task_type: str, context: Dict) -> AgentTaskResult:
        """æ‰§è¡Œ Agent ä»»åŠ¡ï¼ŒåŒ…å«å®¡æ ¸æµç¨‹"""
        
        # 1. ç¡®å®šè´Ÿè´£çš„ Agent
        if task_type in ['parse_script', 'generate_logline', 'generate_synopsis', 
                         'generate_bio', 'estimate_duration']:
            agent = self.script_agent
            agent_name = "script_agent"
        else:
            agent = self.art_agent
            agent_name = "art_agent"
        
        # 2. æ›´æ–°çŠ¶æ€ï¼šAgent å·¥ä½œä¸­
        await self.update_status(task_id, agent_name, "working", 
                                 "ç¼–å‰§ Agent æ­£åœ¨å·¥ä½œ..." if agent_name == "script_agent" 
                                 else "ç¾æœ¯ Agent æ­£åœ¨å·¥ä½œ...")
        
        # 3. æ‰§è¡Œä»»åŠ¡
        result = await agent.execute(task_type, context)
        
        # 4. æ›´æ–°çŠ¶æ€ï¼šå¯¼æ¼” Agent å®¡æ ¸ä¸­
        await self.update_status(task_id, "director_agent", "reviewing", 
                                 "å¯¼æ¼” Agent å®¡æ ¸ä¸­...")
        
        # 5. å¯¼æ¼” Agent å®¡æ ¸
        review_result = await self.director_agent.review(result, task_type)
        
        # 6. è¿”å›ç»“æœ
        return AgentTaskResult(
            agent=agent_name,
            result=result,
            review=review_result,
            status="completed"
        )


class ScriptAgent:
    """ç¼–å‰§ Agent"""
    
    async def parse_script(self, content: str, format: str) -> ScriptParseResult:
        """è§£æå‰§æœ¬ï¼Œæå–åœºæ¬¡å’Œè§’è‰²ä¿¡æ¯"""
        pass
    
    async def generate_logline(self, script: str) -> str:
        """ç”Ÿæˆ Logline"""
        pass
    
    async def generate_synopsis(self, script: str) -> str:
        """ç”Ÿæˆæ•…äº‹æ¦‚è¦"""
        pass
    
    async def generate_character_bio(self, character_name: str, script: str) -> str:
        """ç”Ÿæˆäººç‰©å°ä¼ """
        pass
    
    async def estimate_scene_duration(self, scene_content: str) -> int:
        """ä¼°ç®—åœºæ¬¡æ—¶é•¿"""
        pass


class ArtAgent:
    """ç¾æœ¯ Agent"""
    
    async def classify_file(self, file_path: str) -> str:
        """è¯†åˆ«æ–‡ä»¶ç±»å‹"""
        pass
    
    async def extract_metadata(self, file_path: str) -> Dict:
        """æå–æ–‡ä»¶å…ƒæ•°æ®"""
        pass
    
    async def generate_tags(self, file_path: str) -> List[str]:
        """ç”Ÿæˆæè¿°æ ‡ç­¾"""
        pass
    
    async def create_thumbnail(self, file_path: str) -> str:
        """ç”Ÿæˆç¼©ç•¥å›¾"""
        pass


class DirectorAgent:
    """å¯¼æ¼” Agent - å®¡æ ¸å…¶ä»– Agent çš„è¾“å‡º"""
    
    async def review(self, result: Any, task_type: str) -> ReviewResult:
        """å®¡æ ¸ Agent è¾“å‡ºç»“æœ"""
        # ä½¿ç”¨ LLM è¯„ä¼°ç»“æœè´¨é‡
        # è¿”å›å®¡æ ¸æ„è§å’Œå»ºè®®
        pass
```


## æ•°æ®æµç¨‹

### é¡¹ç›®å»ºæ¡£å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é¡¹ç›®å»ºæ¡£æµç¨‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Step 1: åŸºæœ¬ä¿¡æ¯                                                   â”‚
â”‚  â””â”€â”€ ç”¨æˆ·å¡«å†™: æ ‡é¢˜ã€ç±»å‹ã€æ—¶é•¿ã€ç”»å¹…ã€å¸§ç‡                         â”‚
â”‚                                                                      â”‚
â”‚  Step 2: å‰§æœ¬å¯¼å…¥                                                   â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·ä¸Šä¼ å‰§æœ¬æ–‡ä»¶                                               â”‚
â”‚  â”œâ”€â”€ AIService.parse_script() è§£æ                                  â”‚
â”‚  â”‚   â”œâ”€â”€ æå–åœºæ¬¡ä¿¡æ¯                                               â”‚
â”‚  â”‚   â”œâ”€â”€ æå–è§’è‰²åç§°                                               â”‚
â”‚  â”‚   â””â”€â”€ ç”Ÿæˆç»“æ„åˆ†æ                                               â”‚
â”‚  â””â”€â”€ è‡ªåŠ¨å¡«å…… scenes å’Œ characters                                  â”‚
â”‚                                                                      â”‚
â”‚  Step 3: è§’è‰²è®¾å®š                                                   â”‚
â”‚  â”œâ”€â”€ æ˜¾ç¤ºè§£æå‡ºçš„è§’è‰²åˆ—è¡¨                                           â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·å¯ç¼–è¾‘è§’è‰²ä¿¡æ¯                                             â”‚
â”‚  â””â”€â”€ AIService.generate_character_bio() ç”Ÿæˆäººç‰©å°ä¼                 â”‚
â”‚                                                                      â”‚
â”‚  Step 4: åœºæ¬¡è§„åˆ’                                                   â”‚
â”‚  â”œâ”€â”€ æ˜¾ç¤ºè§£æå‡ºçš„åœºæ¬¡åˆ—è¡¨                                           â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·å¯ç¼–è¾‘åœºæ¬¡ä¿¡æ¯                                             â”‚
â”‚  â””â”€â”€ AIService.estimate_scene_duration() ä¼°ç®—æ—¶é•¿                   â”‚
â”‚                                                                      â”‚
â”‚  Step 5: å‚è€ƒèµ„æ–™                                                   â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·ä¸Šä¼ å‚è€ƒå›¾ç‰‡/è§†é¢‘                                          â”‚
â”‚  â”œâ”€â”€ AssetProcessor.classify_file() åˆ†ç±»                            â”‚
â”‚  â”œâ”€â”€ AssetProcessor.extract_metadata() æå–å…ƒæ•°æ®                   â”‚
â”‚  â”œâ”€â”€ AssetProcessor.generate_tags() ç”Ÿæˆæ ‡ç­¾                        â”‚
â”‚  â””â”€â”€ å­˜å‚¨åˆ°ç´ æåº“ï¼Œä¸º Beatboard å‡†å¤‡                                â”‚
â”‚                                                                      â”‚
â”‚  Step 6: ç¡®è®¤æäº¤                                                   â”‚
â”‚  â”œâ”€â”€ æ£€æŸ¥ç¼ºå¤±å­—æ®µ                                                   â”‚
â”‚  â”œâ”€â”€ å¼¹å‡º MissingContentDialogï¼ˆå¦‚æœ‰ç¼ºå¤±ï¼‰                          â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·é€‰æ‹©å¤„ç†æ–¹å¼                                               â”‚
â”‚  â”œâ”€â”€ éªŒè¯é¡¹ç›®ä¿¡æ¯                                                   â”‚
â”‚  â””â”€â”€ åˆ›å»ºé¡¹ç›®ï¼Œè·³è½¬åˆ° Analysis é˜¶æ®µ                                 â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç´ æå¤„ç†ä¸ Beatboard é›†æˆæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ç´ æå¤„ç†ä¸ Beatboard é›†æˆ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  1. ç«‹é¡¹é˜¶æ®µ - ç´ æä¸Šä¼                                              â”‚
â”‚     â”œâ”€â”€ ç”¨æˆ·ä¸Šä¼ å‚è€ƒå›¾ç‰‡/è§†é¢‘                                       â”‚
â”‚     â”œâ”€â”€ AssetProcessor å¤„ç†:                                        â”‚
â”‚     â”‚   â”œâ”€â”€ ç”Ÿæˆç¼©ç•¥å›¾ (thumbnail)                                  â”‚
â”‚     â”‚   â”œâ”€â”€ ç”Ÿæˆä»£ç†æ–‡ä»¶ (proxy)                                    â”‚
â”‚     â”‚   â”œâ”€â”€ æå–å…ƒæ•°æ® (åˆ†è¾¨ç‡ã€æ—¶é•¿ã€é¢œè‰²)                         â”‚
â”‚     â”‚   â””â”€â”€ AI ç”Ÿæˆæ ‡ç­¾ (å†…å®¹ã€é£æ ¼ã€æŠ€æœ¯)                          â”‚
â”‚     â””â”€â”€ å­˜å‚¨åˆ°ç´ æåº“ (assets è¡¨)                                    â”‚
â”‚                                                                      â”‚
â”‚  2. ç«‹é¡¹å®Œæˆ - æ•°æ®æ‰“åŒ…                                             â”‚
â”‚     â””â”€â”€ é¡¹ç›®ä¿¡æ¯æ‰“åŒ…:                                               â”‚
â”‚         â”œâ”€â”€ è§’è‰²åˆ—è¡¨ + äººç‰©å°ä¼                                      â”‚
â”‚         â”œâ”€â”€ åœºæ¬¡åˆ—è¡¨ + æ—¶é•¿ä¼°ç®—                                     â”‚
â”‚         â”œâ”€â”€ é£æ ¼å‚è€ƒæ ‡ç­¾                                            â”‚
â”‚         â””â”€â”€ è§†è§‰å‚è€ƒæ ‡ç­¾                                            â”‚
â”‚                                                                      â”‚
â”‚  3. Beatboard é˜¶æ®µ - ç´ æå¬å›                                       â”‚
â”‚     â”œâ”€â”€ åŸºäºåœºæ¬¡æè¿°ç”Ÿæˆæœç´¢è¯æ¡                                    â”‚
â”‚     â”œâ”€â”€ åŸºäºè§’è‰²ä¿¡æ¯ç”Ÿæˆæœç´¢è¯æ¡                                    â”‚
â”‚     â”œâ”€â”€ åŸºäºé£æ ¼æ ‡ç­¾è¿›è¡Œç›¸ä¼¼åº¦åŒ¹é…                                  â”‚
â”‚     â””â”€â”€ ä»ç´ æåº“å¬å›åŒ¹é…çš„å‚è€ƒç´ æ                                  â”‚
â”‚                                                                      â”‚
â”‚  4. Beatboard é˜¶æ®µ - ç´ æè£…é…                                       â”‚
â”‚     â”œâ”€â”€ å°†å¬å›çš„ç´ ææ¨èç»™ç”¨æˆ·                                      â”‚
â”‚     â”œâ”€â”€ ç”¨æˆ·é€‰æ‹©/æ›¿æ¢ç´ æ                                           â”‚
â”‚     â””â”€â”€ è£…é…åˆ°æ•…äº‹æ¿ä¸­                                              â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Models

### ProjectWizardDraft è¡¨ï¼ˆè‰ç¨¿ï¼‰

```python
class ProjectWizardDraft(Base):
    """é¡¹ç›®å»ºæ¡£è‰ç¨¿ - ä¿å­˜ç”¨æˆ·è¿›åº¦"""
    __tablename__ = "project_wizard_drafts"
    
    id = Column(String, primary_key=True)
    user_id = Column(String)
    
    # è¿›åº¦
    current_step = Column(Integer, default=1)
    completion_percentage = Column(Float, default=0)
    
    # é¡¹ç›®æ•°æ® (JSON)
    project_data = Column(JSON)
    
    # å­—æ®µçŠ¶æ€ (JSON)
    field_status = Column(JSON)
    
    # æ—¶é—´æˆ³
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)
```

### ProjectTemplate è¡¨

```python
class ProjectTemplate(Base):
    """é¡¹ç›®æ¨¡æ¿"""
    __tablename__ = "project_templates"
    
    id = Column(String, primary_key=True)
    name = Column(String)
    type = Column(String)  # short_film, ad, mv, feature, custom
    description = Column(String)
    
    # æ¨¡æ¿æ•°æ® (JSON)
    template_data = Column(JSON)
    
    # æ˜¯å¦ç³»ç»Ÿé¢„è®¾
    is_system = Column(Boolean, default=False)
    
    # ç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿
    user_id = Column(String, nullable=True)
    
    created_at = Column(DateTime, default=datetime.utcnow)
```

### AITask è¡¨

```python
class AITask(Base):
    """AI ä»»åŠ¡è®°å½•"""
    __tablename__ = "ai_tasks"
    
    id = Column(String, primary_key=True)
    type = Column(String)  # parse_script, generate_logline, etc.
    status = Column(String)  # pending, processing, completed, failed
    
    # è¾“å…¥å‚æ•° (JSON)
    input_params = Column(JSON)
    
    # è¾“å‡ºç»“æœ (JSON)
    result = Column(JSON, nullable=True)
    
    # é”™è¯¯ä¿¡æ¯
    error_message = Column(String, nullable=True)
    
    # è¿›åº¦ (0-100)
    progress = Column(Integer, default=0)
    
    created_at = Column(DateTime, default=datetime.utcnow)
    completed_at = Column(DateTime, nullable=True)
```

## Error Handling

### é”™è¯¯ç±»å‹

1. **æ–‡ä»¶è§£æé”™è¯¯**
   - ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼
   - æ–‡ä»¶æŸåæˆ–æ— æ³•è¯»å–
   - å‰§æœ¬æ ¼å¼æ— æ³•è¯†åˆ«

2. **AI ç”Ÿæˆé”™è¯¯**
   - LLM æœåŠ¡ä¸å¯ç”¨
   - ç”Ÿæˆè¶…æ—¶
   - å†…å®¹ä¸ç¬¦åˆé¢„æœŸ

3. **ç´ æå¤„ç†é”™è¯¯**
   - æ–‡ä»¶è¿‡å¤§
   - æ ¼å¼ä¸æ”¯æŒ
   - å…ƒæ•°æ®æå–å¤±è´¥

### é”™è¯¯å¤„ç†ç­–ç•¥

```python
class WizardError(Exception):
    def __init__(self, code: str, message: str, recoverable: bool = True):
        self.code = code
        self.message = message
        self.recoverable = recoverable

ERROR_CODES = {
    "SCRIPT_PARSE_FAILED": "å‰§æœ¬è§£æå¤±è´¥",
    "AI_SERVICE_UNAVAILABLE": "AI æœåŠ¡ä¸å¯ç”¨",
    "AI_GENERATION_TIMEOUT": "AI ç”Ÿæˆè¶…æ—¶",
    "ASSET_TOO_LARGE": "æ–‡ä»¶è¿‡å¤§",
    "UNSUPPORTED_FORMAT": "ä¸æ”¯æŒçš„æ ¼å¼",
}
```

## ç´ æé¢„å¤„ç†ç®¡é“

### é¢„å¤„ç†æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç´ æé¢„å¤„ç†ç®¡é“ (ä¸Šä¼ æ—¶è‡ªåŠ¨æ‰§è¡Œ)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  ç´ æä¸Šä¼  â†’ PySceneDetect â†’ Gemini æ ‡ç­¾ â†’ Milvus å­˜å‚¨               â”‚
â”‚     â”‚         (é•œå¤´åˆ†å‰²)    (è§†é¢‘ç†è§£)    (å‘é‡ç´¢å¼•)                  â”‚
â”‚     â”‚            â”‚             â”‚             â”‚                       â”‚
â”‚     â”‚      â‰¤10ç§’ç‰‡æ®µ      JSONæ ‡ç­¾      768ç»´å‘é‡                    â”‚
â”‚     â”‚            â”‚             â”‚             â”‚                       â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                         â†“                                            â”‚
â”‚                   é¢„å¤„ç†å®Œæˆï¼Œæ ‡ç­¾å·²å­˜å‚¨                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### VideoPreprocessor å®ç°

```python
class VideoPreprocessor:
    """è§†é¢‘é¢„å¤„ç†å™¨ - ç´ æä¸Šä¼ æ—¶è‡ªåŠ¨æ‰§è¡Œå®Œæ•´å¤„ç†æµç¨‹"""
    
    def __init__(self, gemini_api_key: str, milvus_host: str = "localhost"):
        # é•œå¤´åˆ†å‰²
        self.scene_detector = ContentDetector(threshold=27.0)
        self.max_scene_duration = 10.0  # â‰¤10ç§’
        
        # Gemini æ ‡ç­¾
        genai.configure(api_key=gemini_api_key)
        self.gemini = genai.GenerativeModel('gemini-2.5-flash')
        
        # å‘é‡ç”Ÿæˆ (ä½¿ç”¨ sentence-transformersï¼Œå…è´¹æœ¬åœ°è¿è¡Œ)
        self.embedder = SentenceTransformer('paraphrase-multilingual-MiniLM-L12-v2')
        
        # Milvus å­˜å‚¨
        self.milvus = MilvusVideoStore(host=milvus_host)
    
    async def preprocess(self, video_path: str, asset_id: str) -> Dict:
        """å®Œæ•´é¢„å¤„ç†æµç¨‹"""
        # Step 1: PySceneDetect é•œå¤´åˆ†å‰²
        # Step 2: ç¡®ä¿ â‰¤10ç§’ å¹¶åˆ‡å‰²
        # Step 3: Gemini æ ‡ç­¾ç”Ÿæˆ
        # Step 4: å­˜å‚¨åˆ° Milvus
        pass
```

### MilvusVideoStore å®ç°

```python
class MilvusVideoStore:
    """Milvus è§†é¢‘å‘é‡å­˜å‚¨"""
    
    def __init__(self, host: str = "localhost", port: int = 19530):
        connections.connect(alias="default", host=host, port=port)
        self.collection_name = "video_assets"
        self._ensure_collection()
    
    def _ensure_collection(self):
        """åˆ›å»ºé›†åˆå’Œç´¢å¼•"""
        fields = [
            FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=True),
            FieldSchema(name="video_path", dtype=DataType.VARCHAR, max_length=500),
            FieldSchema(name="segment_index", dtype=DataType.INT64),
            FieldSchema(name="start_time", dtype=DataType.FLOAT),
            FieldSchema(name="end_time", dtype=DataType.FLOAT),
            FieldSchema(name="tags_json", dtype=DataType.VARCHAR, max_length=2000),
            FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=768),
        ]
        # åˆ›å»º IVF_FLAT ç´¢å¼•ï¼Œä½¿ç”¨ COSINE ç›¸ä¼¼åº¦
    
    def insert(self, video_path, segment_index, start_time, end_time, tags, embedding):
        """æ’å…¥è§†é¢‘ç‰‡æ®µ"""
        pass
    
    def search(self, query_embedding: list, top_k: int = 5) -> list:
        """å‘é‡æœç´¢"""
        pass
    
    def search_by_tags(self, tags: list, top_k: int = 10) -> list:
        """æ ‡ç­¾æœç´¢"""
        pass
```

## Storyboard_Agent è®¾è®¡

### ç´ æå¬å›æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Storyboard_Agent ç´ æå¬å›æµç¨‹                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  åœºæ¬¡æè¿° + æ ‡ç­¾                                                     â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 1: æ ‡ç­¾åŒ¹é…ï¼ˆå¿«é€Ÿï¼‰                                    â”‚   â”‚
â”‚  â”‚  â””â”€â”€ Milvus.search_by_tags() â†’ Top 20 å€™é€‰                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 2: å‘é‡æœç´¢ï¼ˆè¯­ä¹‰ï¼‰                                    â”‚   â”‚
â”‚  â”‚  â””â”€â”€ Milvus.search() â†’ Top 20 å€™é€‰                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 3: åˆå¹¶æ’åº                                            â”‚   â”‚
â”‚  â”‚  â””â”€â”€ äº¤æ›¿åˆå¹¶ï¼Œå»é‡ â†’ Top 5 å€™é€‰                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 4: ç¼“å­˜å€™é€‰                                            â”‚   â”‚
â”‚  â”‚  â””â”€â”€ _candidate_cache[scene_id] = [5 candidates]             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  è¿”å› Top 5 å€™é€‰ï¼Œç”¨æˆ·å¯ä¸æ»‘åˆ‡æ¢                                    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Storyboard_Agent å®ç°

```python
class StoryboardAgent(BaseAgent):
    """æ•…äº‹æ¿ Agent - ç´ æå¬å›ä¸å€™é€‰ç¼“å­˜"""
    
    def __init__(self, agent_id: str, message_bus, milvus_store, config=None):
        super().__init__(
            agent_id=agent_id,
            agent_type=AgentType.STORYBOARD,
            message_bus=message_bus,
            capabilities=["asset_recall", "candidate_cache", "rough_cut"],
            config=config
        )
        self.milvus = milvus_store
        self._candidate_cache = {}  # scene_id -> [5 candidates]
    
    async def recall_assets(self, scene_id: str, scene_tags: list, 
                           scene_description: str) -> list:
        """ç´ æå¬å› - è¿”å› Top 5 å€™é€‰"""
        # 1. æ ‡ç­¾åŒ¹é…ï¼ˆå¿«é€Ÿï¼‰
        tag_results = self.milvus.search_by_tags(scene_tags, top_k=20)
        
        # 2. å‘é‡æœç´¢ï¼ˆè¯­ä¹‰ï¼‰
        query_embedding = await self._generate_embedding(scene_description)
        vector_results = self.milvus.search(query_embedding, top_k=20)
        
        # 3. åˆå¹¶æ’åº
        candidates = self._merge_and_rank(tag_results, vector_results)[:5]
        
        # 4. ç¼“å­˜ 5 ä¸ªå€™é€‰
        self._candidate_cache[scene_id] = candidates
        
        return candidates
    
    def get_cached_candidates(self, scene_id: str) -> list:
        """è·å–ç¼“å­˜çš„å€™é€‰ï¼ˆç”¨æˆ·ä¸æ»‘åˆ‡æ¢ï¼‰"""
        return self._candidate_cache.get(scene_id, [])
    
    def switch_candidate(self, scene_id: str, index: int) -> dict:
        """åˆ‡æ¢å€™é€‰"""
        candidates = self._candidate_cache.get(scene_id, [])
        if 0 <= index < len(candidates):
            return candidates[index]
        return None
    
    async def rough_cut(self, video_path: str, start: float, end: float, 
                       output_path: str) -> str:
        """ç²—å‰ª - ä½¿ç”¨ FFmpeg åˆ‡å‰²"""
        pass
```

## MVP ä¸åç»­è¿ç§»

### MVP é˜¶æ®µï¼ˆå½“å‰ï¼‰

- AIService ç›´æ¥é›†æˆåˆ° Pervis PRO åç«¯
- ä½¿ç”¨ REST API + è½®è¯¢è·å–ä»»åŠ¡çŠ¶æ€
- ç´ æé¢„å¤„ç†ç®¡é“ï¼ˆPySceneDetect + Gemini + Milvusï¼‰
- Storyboard_Agent ç´ æå¬å›ä¸å€™é€‰ç¼“å­˜

### åç»­è¿ç§»è·¯å¾„

1. **ç‹¬ç«‹ Agent æœåŠ¡**
   - å°† AIService è¿ç§»åˆ°ç‹¬ç«‹æœåŠ¡
   - æ·»åŠ  WebSocket å®æ—¶é€šä¿¡
   - æ”¯æŒæ›´å¤æ‚çš„ Agent åä½œ

2. **é›†æˆ multi-agent-workflow**
   - å¤ç”¨ç°æœ‰çš„ Agent æ¶æ„
   - æ·»åŠ  REST API ç½‘å…³
   - å®ç° Agent é—´åä½œæµç¨‹


---

## Correctness Properties

æœ¬èŠ‚å®šä¹‰ç³»ç»Ÿçš„æ­£ç¡®æ€§å±æ€§ï¼Œç”¨äºéªŒè¯å®ç°æ˜¯å¦ç¬¦åˆéœ€æ±‚è§„æ ¼ã€‚æ¯ä¸ªå±æ€§ä½¿ç”¨ Hypothesis åº“è¿›è¡Œå±æ€§æµ‹è¯•ã€‚

### æµ‹è¯•ç­–ç•¥

- **æµ‹è¯•æ¡†æ¶**: Hypothesisï¼ˆPython å±æ€§æµ‹è¯•åº“ï¼‰
- **é…ç½®**: `@settings(max_examples=100, deadline=None)`
- **æµ‹è¯•æ–‡ä»¶å‘½å**: `test_<æ¨¡å—å>_properties.py`
- **æ‰§è¡Œç›®å½•**: `multi-agent-workflow/backend`

### Property 1: å­—æ®µçŠ¶æ€å’Œå®Œæˆåº¦è®¡ç®—

**Title**: å­—æ®µçŠ¶æ€æ­£ç¡®æ€§ä¸å®Œæˆåº¦è®¡ç®—ä¸€è‡´æ€§

**Body**:
```
For all project_data: ProjectData,
  For all field_status: Dict[str, FieldStatus],
    completion_percentage = calculate_completion(project_data, field_status)
    IMPLIES:
      - 0 <= completion_percentage <= 100
      - completion_percentage == (filled_fields / total_fields) * 100
      - field_status[field] in ['empty', 'user_input', 'script_agent', 'art_agent', 'placeholder', 'processing']
      - IF all required_fields are filled THEN completion_percentage >= minimum_required_percentage
```

**Requirements Reference**: 1.3, 1.4, 1.5

---

### Property 2: æ–‡ä»¶æ ¼å¼éªŒè¯

**Title**: æ–‡ä»¶æ ¼å¼è¯†åˆ«ä¸å¤„ç†æ­£ç¡®æ€§

**Body**:
```
For all file: UploadedFile,
  For all format: str in ['txt', 'pdf', 'docx', 'fdx', 'jpg', 'png', 'psd', 'mp4', 'mov', 'avi'],
    result = validate_and_process_file(file, format)
    IMPLIES:
      - IF file.extension in SUPPORTED_SCRIPT_FORMATS THEN result.type == 'script'
      - IF file.extension in SUPPORTED_IMAGE_FORMATS THEN result.type == 'image'
      - IF file.extension in SUPPORTED_VIDEO_FORMATS THEN result.type == 'video'
      - IF file.extension not in ALL_SUPPORTED_FORMATS THEN result.error == 'UNSUPPORTED_FORMAT'
      - result.metadata is not None OR result.error is not None
```

**Requirements Reference**: 2.1, 3.1

---

### Property 3: Art_Agent æ–‡ä»¶åˆ†ç±»æ­£ç¡®æ€§

**Title**: Art_Agent æ–‡ä»¶æ™ºèƒ½åˆ†ç±»ä¸€è‡´æ€§

**Body**:
```
For all files: List[UploadedFile],
  For all classification_result: ClassificationResult,
    classification_result = art_agent.classify_files(files)
    IMPLIES:
      - For all file in files:
          file is in classification_result.characters OR
          file is in classification_result.scenes OR
          file is in classification_result.references
      - len(classification_result.characters) + len(classification_result.scenes) + len(classification_result.references) == len(files)
      - IF file cannot be classified THEN file is in classification_result.references
      - classification_result.requires_user_confirmation == True for unclassified files
```

**Requirements Reference**: 3.2, 3.3, 5.3, 5.4

---

### Property 4: ç¼ºå¤±å†…å®¹å¤„ç†é€‰é¡¹å®Œæ•´æ€§

**Title**: ç¼ºå¤±å†…å®¹å¤„ç†é€‰é¡¹æ­£ç¡®æ€§

**Body**:
```
For all missing_fields: List[MissingField],
  For all action: ContentAction in ['placeholder', 'agent_generate', 'manual_input'],
    result = handle_missing_content(missing_fields, action)
    IMPLIES:
      - IF action == 'placeholder' THEN result.field_status == 'placeholder' AND result.content == PLACEHOLDER_TEXT
      - IF action == 'agent_generate' THEN result.task_id is not None AND result.agent in ['script_agent', 'art_agent']
      - IF action == 'manual_input' THEN result.requires_user_input == True
      - For all field in missing_fields: field has exactly 3 available actions
```

**Requirements Reference**: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6

---

### Property 5: Director_Agent å®¡æ ¸æœºåˆ¶æ­£ç¡®æ€§

**Title**: Director_Agent å®¡æ ¸æµç¨‹ä¸é¡¹ç›®è®°å¿†ä¸€è‡´æ€§

**Body**:
```
For all agent_output: AgentOutput,
  For all project_context: ProjectContext,
    review_result = director_agent.review(agent_output, project_context)
    IMPLIES:
      - review_result.status in ['approved', 'suggestions', 'rejected']
      - IF review_result.status == 'rejected' THEN review_result.reason is not None
      - IF review_result.status == 'suggestions' THEN len(review_result.suggestions) > 0
      - review_result.checks_performed includes ['rule_check', 'spec_check', 'style_check', 'history_check']
      - IF agent_output contradicts project_context.user_decisions THEN review_result.status != 'approved'
      - IF agent_output similar_to project_context.rejected_versions THEN review_result.status == 'suggestions'
```

**Requirements Reference**: 5.1.1, 5.1.2, 5.1.3, 5.1.4, 5.1.5, 5.1.6, 5.1.7

---

### Property 6: PM_Agent ç‰ˆæœ¬ç®¡ç†æ­£ç¡®æ€§

**Title**: PM_Agent ç‰ˆæœ¬è®°å½•ä¸å‘½åä¸€è‡´æ€§

**Body**:
```
For all project_id: str,
  For all content_type: str,
  For all content: Any,
    version_result = pm_agent.record_version(project_id, content_type, content)
    IMPLIES:
      - version_result.version == previous_version + 1
      - version_result.version_name matches pattern '{content_type}_{name}_v{version}.{ext}'
      - version_result.created_at is not None
      - pm_agent.get_version_history(project_id) includes version_result
      - IF user confirms content THEN pm_agent.record_decision(version_id, 'accepted') succeeds
      - pm_agent.get_version_display_info(project_id).current_version == version_result.version
```

**Requirements Reference**: 5.2.1, 5.2.2, 5.2.3, 5.2.4, 5.2.5, 5.2.6, 5.2.7

---

### Property 7: é¡¹ç›®ä¿¡æ¯éªŒè¯æ­£ç¡®æ€§

**Title**: é¡¹ç›®ä¿¡æ¯å¿…å¡«å­—æ®µä¸æ ¼å¼éªŒè¯

**Body**:
```
For all project_data: ProjectData,
    validation_result = validate_project(project_data)
    IMPLIES:
      - IF project_data.title is empty THEN validation_result.errors includes 'title_required'
      - IF project_data.type is empty THEN validation_result.errors includes 'type_required'
      - IF project_data.script is empty AND project_data.synopsis is empty THEN validation_result.errors includes 'script_or_synopsis_required'
      - IF project_data.duration is not None THEN project_data.duration > 0
      - IF project_data.aspect_ratio is not None THEN project_data.aspect_ratio matches pattern '\d+:\d+'
      - IF project_data.frame_rate is not None THEN project_data.frame_rate in [24, 25, 30, 60]
      - validation_result.is_valid == (len(validation_result.errors) == 0)
```

**Requirements Reference**: 6.1, 6.2, 6.3, 6.4

---

### Property 8: Agent çŠ¶æ€æ˜¾ç¤ºæ­£ç¡®æ€§

**Title**: Agent å·¥ä½œçŠ¶æ€ä¸æµç¨‹æ˜¾ç¤ºä¸€è‡´æ€§

**Body**:
```
For all task: AgentTask,
    status_display = get_agent_status_display(task)
    IMPLIES:
      - IF task.status == 'working' AND task.agent_type == 'script_agent' THEN status_display.message == 'ç¼–å‰§ Agent æ­£åœ¨å·¥ä½œ...'
      - IF task.status == 'working' AND task.agent_type == 'art_agent' THEN status_display.message == 'ç¾æœ¯ Agent æ­£åœ¨å·¥ä½œ...'
      - IF task.status == 'reviewing' THEN status_display.message == 'å¯¼æ¼” Agent å®¡æ ¸ä¸­...'
      - IF task.status == 'completed' THEN status_display.result_summary is not None
      - IF task.status == 'failed' THEN status_display.error_message is not None AND status_display.retry_available == True
      - status_display.workflow_diagram shows correct flow: Agentå·¥ä½œ â†’ Directorå®¡æ ¸ â†’ ç”¨æˆ·ç¡®è®¤
```

**Requirements Reference**: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 9.8, 9.9

---

### Property 9: Storyboard_Agent ç´ æå¬å›æ­£ç¡®æ€§

**Title**: ç´ æå¬å›ä¸å€™é€‰ç¼“å­˜ä¸€è‡´æ€§

**Body**:
```
For all scene_id: str,
  For all scene_tags: List[str],
  For all scene_description: str,
    recall_result = storyboard_agent.recall_assets(scene_id, scene_tags, scene_description)
    IMPLIES:
      - len(recall_result) <= 5
      - storyboard_agent.get_cached_candidates(scene_id) == recall_result
      - For all index in range(len(recall_result)):
          storyboard_agent.switch_candidate(scene_id, index) == recall_result[index]
      - IF no matching assets THEN recall_result == [] AND display shows placeholder
      - recall_result is sorted by relevance_score descending
      - For all candidate in recall_result:
          candidate.video_path exists AND candidate.start_time < candidate.end_time
```

**Requirements Reference**: 15.1, 15.2, 15.3, 15.4, 15.5, 15.6, 15.7

---

### Property 10: ç´ æé¢„å¤„ç†ç®¡é“æ­£ç¡®æ€§

**Title**: è§†é¢‘é¢„å¤„ç†æµç¨‹ä¸å­˜å‚¨ä¸€è‡´æ€§

**Body**:
```
For all video_path: str,
  For all asset_id: str,
    preprocess_result = video_preprocessor.preprocess(video_path, asset_id)
    IMPLIES:
      - For all segment in preprocess_result.segments:
          segment.duration <= 10.0  # â‰¤10ç§’
          segment.start_time < segment.end_time
          segment.tags is not None
          segment.embedding is not None AND len(segment.embedding) == 768
      - preprocess_result.segments are stored in Milvus
      - preprocess_result.tags includes ['scene_type', 'time', 'shot_type', 'mood', 'action', 'characters', 'free_tags', 'summary']
      - IF preprocess fails THEN preprocess_result.error is not None AND retry is available
      - milvus.search(segment.embedding) returns segment in top results
```

**Requirements Reference**: 16.1, 16.2, 16.3, 16.4, 16.5, 16.6, 17.1, 17.2, 17.3, 17.4, 17.5

---

### å±æ€§æµ‹è¯•ç¤ºä¾‹ä»£ç 

```python
# test_wizard_properties.py
from hypothesis import given, settings, strategies as st
from hypothesis.strategies import composite

@composite
def project_data_strategy(draw):
    """ç”Ÿæˆ ProjectData æµ‹è¯•æ•°æ®"""
    return ProjectData(
        title=draw(st.text(min_size=0, max_size=100)),
        type=draw(st.sampled_from(['short_film', 'ad', 'mv', 'feature', ''])),
        duration=draw(st.integers(min_value=0, max_value=7200)),
        aspect_ratio=draw(st.sampled_from(['16:9', '4:3', '21:9', '1:1', ''])),
        frame_rate=draw(st.sampled_from([24, 25, 30, 60, 0])),
        script=draw(st.text(min_size=0, max_size=10000)),
        synopsis=draw(st.text(min_size=0, max_size=1000)),
    )

@settings(max_examples=100, deadline=None)
@given(project_data=project_data_strategy())
def test_completion_percentage_bounds(project_data):
    """Property 1: å®Œæˆåº¦ç™¾åˆ†æ¯”åœ¨æœ‰æ•ˆèŒƒå›´å†…"""
    field_status = calculate_field_status(project_data)
    completion = calculate_completion(project_data, field_status)
    
    assert 0 <= completion <= 100
    assert isinstance(completion, (int, float))

@settings(max_examples=100, deadline=None)
@given(
    content_type=st.sampled_from(['è§’è‰²', 'åœºæ¬¡å¤§çº²', 'Logline', 'Synopsis']),
    name=st.text(alphabet='abcdefghijklmnopqrstuvwxyz0123456789_-', min_size=1, max_size=20),
    version=st.integers(min_value=1, max_value=100)
)
def test_version_name_format(content_type, name, version):
    """Property 6: ç‰ˆæœ¬å‘½åæ ¼å¼æ­£ç¡®"""
    version_name = pm_agent.generate_version_name(content_type, version, name)
    
    assert f"_v{version}" in version_name
    assert content_type in version_name
    assert name in version_name

@settings(max_examples=100, deadline=None)
@given(
    scene_tags=st.lists(st.text(alphabet='abcdefghijklmnopqrstuvwxyz0123456789_-', min_size=1, max_size=20), min_size=0, max_size=10),
    scene_description=st.text(min_size=0, max_size=500)
)
def test_recall_assets_returns_at_most_5(scene_tags, scene_description):
    """Property 9: ç´ æå¬å›æœ€å¤šè¿”å› 5 ä¸ªå€™é€‰"""
    scene_id = "test_scene_001"
    result = storyboard_agent.recall_assets(scene_id, scene_tags, scene_description)
    
    assert len(result) <= 5
    assert storyboard_agent.get_cached_candidates(scene_id) == result
```

---

## è®¾è®¡æ–‡æ¡£å®¡æ ¸æ¸…å•

- [x] é—®é¢˜åˆ†æå®Œæˆï¼ˆP0-1 åˆ° P0-7ï¼‰
- [x] æ¶æ„è®¾è®¡å®Œæˆï¼ˆç®€åŒ– MVP æ–¹æ¡ˆï¼‰
- [x] ç»„ä»¶æ¥å£å®šä¹‰å®Œæˆ
- [x] æ•°æ®æ¨¡å‹å®šä¹‰å®Œæˆ
- [x] é”™è¯¯å¤„ç†ç­–ç•¥å®šä¹‰å®Œæˆ
- [x] ç´ æé¢„å¤„ç†ç®¡é“è®¾è®¡å®Œæˆ
- [x] Storyboard_Agent è®¾è®¡å®Œæˆ
- [x] Correctness Properties å®šä¹‰å®Œæˆï¼ˆ10 ä¸ªæ ¸å¿ƒå±æ€§ï¼‰
- [x] æµ‹è¯•ç­–ç•¥å®šä¹‰å®Œæˆï¼ˆHypothesis å±æ€§æµ‹è¯•ï¼‰



---

## è¡¥å……è®¾è®¡ï¼šProjectValidator ç»„ä»¶ï¼ˆReq 6ï¼‰

### éªŒè¯è§„åˆ™å®šä¹‰

```python
class ProjectValidator:
    """é¡¹ç›®ä¿¡æ¯éªŒè¯å™¨ - éªŒè¯å¿…å¡«å­—æ®µå’Œæ ¼å¼"""
    
    # å¿…å¡«å­—æ®µå®šä¹‰
    REQUIRED_FIELDS = {
        'title': 'é¡¹ç›®æ ‡é¢˜',
        'type': 'é¡¹ç›®ç±»å‹',
    }
    
    # è‡³å°‘ä¸€é¡¹å¿…å¡«
    REQUIRED_ONE_OF = {
        'script_or_synopsis': ['script', 'synopsis']
    }
    
    # æ ¼å¼éªŒè¯è§„åˆ™
    FORMAT_RULES = {
        'duration': {
            'type': 'positive_integer',
            'error': 'æ—¶é•¿å¿…é¡»ä¸ºæ­£æ•´æ•°ï¼ˆç§’ï¼‰'
        },
        'aspect_ratio': {
            'pattern': r'^\d+:\d+$',
            'error': 'ç”»å¹…æ¯”ä¾‹æ ¼å¼æ— æ•ˆï¼ˆå¦‚ 16:9ã€4:3ï¼‰'
        },
        'frame_rate': {
            'allowed_values': [24, 25, 30, 60],
            'error': 'å¸§ç‡å¿…é¡»ä¸º 24ã€25ã€30 æˆ– 60'
        }
    }

    
    def validate(self, project_data: ProjectData) -> ValidationResult:
        """éªŒè¯é¡¹ç›®æ•°æ®"""
        errors = []
        
        # 1. å¿…å¡«å­—æ®µéªŒè¯
        for field, name in self.REQUIRED_FIELDS.items():
            if not getattr(project_data, field, None):
                errors.append(ValidationError(
                    field=field,
                    code=f'{field}_required',
                    message=f'{name}ä¸ºå¿…å¡«é¡¹'
                ))
        
        # 2. è‡³å°‘ä¸€é¡¹å¿…å¡«éªŒè¯
        for rule_name, fields in self.REQUIRED_ONE_OF.items():
            if not any(getattr(project_data, f, None) for f in fields):
                errors.append(ValidationError(
                    field=rule_name,
                    code=f'{rule_name}_required',
                    message='å‰§æœ¬æˆ–æ•…äº‹æ¦‚è¦è‡³å°‘å¡«å†™ä¸€é¡¹'
                ))
        
        # 3. æ ¼å¼éªŒè¯
        errors.extend(self._validate_formats(project_data))
        
        return ValidationResult(
            is_valid=len(errors) == 0,
            errors=errors
        )

    
    def _validate_formats(self, project_data: ProjectData) -> List[ValidationError]:
        """æ ¼å¼éªŒè¯"""
        errors = []
        
        # æ—¶é•¿éªŒè¯
        if project_data.duration is not None:
            if not isinstance(project_data.duration, int) or project_data.duration <= 0:
                errors.append(ValidationError(
                    field='duration',
                    code='invalid_duration',
                    message=self.FORMAT_RULES['duration']['error']
                ))
        
        # ç”»å¹…æ¯”ä¾‹éªŒè¯
        if project_data.aspect_ratio:
            import re
            if not re.match(self.FORMAT_RULES['aspect_ratio']['pattern'], project_data.aspect_ratio):
                errors.append(ValidationError(
                    field='aspect_ratio',
                    code='invalid_aspect_ratio',
                    message=self.FORMAT_RULES['aspect_ratio']['error']
                ))
        
        # å¸§ç‡éªŒè¯
        if project_data.frame_rate is not None:
            if project_data.frame_rate not in self.FORMAT_RULES['frame_rate']['allowed_values']:
                errors.append(ValidationError(
                    field='frame_rate',
                    code='invalid_frame_rate',
                    message=self.FORMAT_RULES['frame_rate']['error']
                ))
        
        return errors


@dataclass
class ValidationError:
    field: str
    code: str
    message: str


@dataclass
class ValidationResult:
    is_valid: bool
    errors: List[ValidationError]
```


---

## è¡¥å……è®¾è®¡ï¼šæ¨¡æ¿ç®¡ç† APIï¼ˆReq 8ï¼‰

### æ¨¡æ¿ CRUD API è®¾è®¡

```python
# POST /api/wizard/templates - åˆ›å»ºæ¨¡æ¿
class CreateTemplateRequest(BaseModel):
    name: str
    type: str  # short_film, ad, mv, feature, custom
    description: str
    template_data: Dict[str, Any]

class CreateTemplateResponse(BaseModel):
    id: str
    name: str
    created_at: datetime

# GET /api/wizard/templates - è·å–æ¨¡æ¿åˆ—è¡¨
class TemplateListResponse(BaseModel):
    templates: List[TemplateInfo]
    total: int

class TemplateInfo(BaseModel):
    id: str
    name: str
    type: str
    description: str
    is_system: bool
    created_at: datetime


# GET /api/wizard/templates/{id} - è·å–æ¨¡æ¿è¯¦æƒ…
class TemplateDetailResponse(BaseModel):
    id: str
    name: str
    type: str
    description: str
    template_data: Dict[str, Any]
    is_system: bool
    created_at: datetime

# PUT /api/wizard/templates/{id} - æ›´æ–°æ¨¡æ¿
class UpdateTemplateRequest(BaseModel):
    name: Optional[str]
    description: Optional[str]
    template_data: Optional[Dict[str, Any]]

# DELETE /api/wizard/templates/{id} - åˆ é™¤æ¨¡æ¿
# è¿”å› 204 No Contentï¼Œç³»ç»Ÿæ¨¡æ¿ä¸å¯åˆ é™¤
```

### æ¨¡æ¿æœåŠ¡å®ç°

```python
class TemplateService:
    """æ¨¡æ¿ç®¡ç†æœåŠ¡"""
    
    def __init__(self, db: Database):
        self.db = db
    
    async def create_template(self, user_id: str, request: CreateTemplateRequest) -> str:
        """åˆ›å»ºç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿"""
        template_id = str(uuid.uuid4())
        await self.db.insert("project_templates", {
            "id": template_id,
            "name": request.name,
            "type": request.type,
            "description": request.description,
            "template_data": request.template_data,
            "is_system": False,
            "user_id": user_id,
            "created_at": datetime.now()
        })
        return template_id

    
    async def list_templates(self, user_id: str) -> List[TemplateInfo]:
        """è·å–æ¨¡æ¿åˆ—è¡¨ï¼ˆç³»ç»Ÿæ¨¡æ¿ + ç”¨æˆ·æ¨¡æ¿ï¼‰"""
        templates = await self.db.query(
            "SELECT * FROM project_templates WHERE is_system = 1 OR user_id = ?",
            [user_id]
        )
        return [TemplateInfo(**t) for t in templates]
    
    async def get_template(self, template_id: str) -> Optional[TemplateDetailResponse]:
        """è·å–æ¨¡æ¿è¯¦æƒ…"""
        template = await self.db.query_one(
            "SELECT * FROM project_templates WHERE id = ?",
            [template_id]
        )
        return TemplateDetailResponse(**template) if template else None
    
    async def update_template(self, template_id: str, user_id: str, 
                             request: UpdateTemplateRequest) -> bool:
        """æ›´æ–°æ¨¡æ¿ï¼ˆä»…é™ç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿ï¼‰"""
        template = await self.get_template(template_id)
        if not template or template.is_system or template.user_id != user_id:
            return False
        
        update_data = {k: v for k, v in request.dict().items() if v is not None}
        await self.db.update("project_templates", template_id, update_data)
        return True
    
    async def delete_template(self, template_id: str, user_id: str) -> bool:
        """åˆ é™¤æ¨¡æ¿ï¼ˆä»…é™ç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿ï¼‰"""
        template = await self.get_template(template_id)
        if not template or template.is_system or template.user_id != user_id:
            return False
        
        await self.db.delete("project_templates", template_id)
        return True
```


---

## è¡¥å……è®¾è®¡ï¼šMarket_Agent å¸‚åœºåˆ†æï¼ˆReq 11ï¼‰

### Market_Agent æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Market_Agent å¸‚åœºåˆ†ææµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  é¡¹ç›®åŸºæœ¬ä¿¡æ¯ï¼ˆç±»å‹ã€æ—¶é•¿ã€é£æ ¼ï¼‰                                   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 1: ç›®æ ‡å—ä¼—åˆ†æ                                        â”‚   â”‚
â”‚  â”‚  â””â”€â”€ åŸºäºé¡¹ç›®ç±»å‹å’Œé£æ ¼ï¼Œåˆ†æç›®æ ‡è§‚ä¼—ç¾¤ä½“                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 2: å¸‚åœºå®šä½å»ºè®®                                        â”‚   â”‚
â”‚  â”‚  â””â”€â”€ åˆ†æé¡¹ç›®åœ¨å¸‚åœºä¸­çš„å®šä½å’Œå·®å¼‚åŒ–ä¼˜åŠ¿                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 3: ç«å“åˆ†æ                                            â”‚   â”‚
â”‚  â”‚  â””â”€â”€ è¯†åˆ«åŒç±»å‹é¡¹ç›®ï¼Œåˆ†æä¼˜åŠ£åŠ¿                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 4: å‘è¡Œæ¸ é“å»ºè®®                                        â”‚   â”‚
â”‚  â”‚  â””â”€â”€ æ¨èé€‚åˆçš„å‘è¡Œå¹³å°å’Œæ¸ é“                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### Market_Agent å®ç°

```python
class MarketAgent(BaseAgent):
    """å¸‚åœºåˆ†æ Agent - æä¾›ä¸“ä¸šçš„å¸‚åœºåˆ†æå’Œå»ºè®®"""
    
    def __init__(self, agent_id: str, message_bus, llm_provider: LLMProvider, config=None):
        super().__init__(
            agent_id=agent_id,
            agent_type=AgentType.MARKET,
            message_bus=message_bus,
            capabilities=["audience_analysis", "market_positioning", 
                         "competitor_analysis", "distribution_recommendation"],
            config=config
        )
        self.llm = llm_provider
    
    async def analyze(self, project_data: ProjectData) -> MarketAnalysisResult:
        """æ‰§è¡Œå®Œæ•´å¸‚åœºåˆ†æï¼ˆåŠ¨æ€æ•°æ®ï¼Œéé™æ€æ¡ˆä¾‹ï¼‰"""
        
        # 1. ç›®æ ‡å—ä¼—åˆ†æ
        audience = await self._analyze_audience(project_data)
        
        # 2. å¸‚åœºå®šä½å»ºè®®
        positioning = await self._analyze_positioning(project_data)
        
        # 3. ç«å“åˆ†æ
        competitors = await self._analyze_competitors(project_data)
        
        # 4. å‘è¡Œæ¸ é“å»ºè®®
        distribution = await self._recommend_distribution(project_data)
        
        return MarketAnalysisResult(
            audience=audience,
            positioning=positioning,
            competitors=competitors,
            distribution=distribution,
            generated_at=datetime.now(),
            is_dynamic=True  # æ ‡è®°ä¸ºåŠ¨æ€æ•°æ®
        )

    
    async def _analyze_audience(self, project_data: ProjectData) -> AudienceAnalysis:
        """ç›®æ ‡å—ä¼—åˆ†æï¼ˆä½¿ç”¨ LLM åŠ¨æ€ç”Ÿæˆï¼‰"""
        prompt = f"""
        è¯·åˆ†æä»¥ä¸‹é¡¹ç›®çš„ç›®æ ‡å—ä¼—ï¼š
        
        é¡¹ç›®ç±»å‹ï¼š{project_data.type}
        æ—¶é•¿ï¼š{project_data.duration}ç§’
        é£æ ¼ï¼š{project_data.style_description or 'æœªæŒ‡å®š'}
        æ•…äº‹æ¦‚è¦ï¼š{project_data.synopsis or 'æœªæä¾›'}
        
        è¯·æä¾›ï¼š
        1. ä¸»è¦ç›®æ ‡å—ä¼—ç¾¤ä½“ï¼ˆå¹´é¾„ã€æ€§åˆ«ã€å…´è¶£ï¼‰
        2. æ¬¡è¦ç›®æ ‡å—ä¼—ç¾¤ä½“
        3. å—ä¼—è§‚çœ‹ä¹ æƒ¯åˆ†æ
        4. å—ä¼—ç—›ç‚¹å’Œéœ€æ±‚
        
        ä»¥ JSON æ ¼å¼è¿”å›ã€‚
        """
        response = await self.llm.generate(prompt)
        return AudienceAnalysis.parse(response)
    
    async def _analyze_positioning(self, project_data: ProjectData) -> PositioningAnalysis:
        """å¸‚åœºå®šä½åˆ†æ"""
        # ä½¿ç”¨ LLM åˆ†æå¸‚åœºå®šä½
        pass
    
    async def _analyze_competitors(self, project_data: ProjectData) -> CompetitorAnalysis:
        """ç«å“åˆ†æ"""
        # ä½¿ç”¨ LLM åˆ†æåŒç±»å‹é¡¹ç›®
        pass
    
    async def _recommend_distribution(self, project_data: ProjectData) -> DistributionRecommendation:
        """å‘è¡Œæ¸ é“å»ºè®®"""
        # ä½¿ç”¨ LLM æ¨èå‘è¡Œæ¸ é“
        pass


@dataclass
class MarketAnalysisResult:
    """å¸‚åœºåˆ†æç»“æœ"""
    audience: AudienceAnalysis
    positioning: PositioningAnalysis
    competitors: CompetitorAnalysis
    distribution: DistributionRecommendation
    generated_at: datetime
    is_dynamic: bool = True  # æ ‡è®°ä¸ºåŠ¨æ€æ•°æ®ï¼Œéé™æ€æ¡ˆä¾‹


@dataclass
class AudienceAnalysis:
    """ç›®æ ‡å—ä¼—åˆ†æ"""
    primary_audience: Dict[str, Any]  # ä¸»è¦å—ä¼—
    secondary_audience: Dict[str, Any]  # æ¬¡è¦å—ä¼—
    viewing_habits: List[str]  # è§‚çœ‹ä¹ æƒ¯
    pain_points: List[str]  # ç—›ç‚¹å’Œéœ€æ±‚


@dataclass
class PositioningAnalysis:
    """å¸‚åœºå®šä½åˆ†æ"""
    market_position: str  # å¸‚åœºå®šä½æè¿°
    differentiation: List[str]  # å·®å¼‚åŒ–ä¼˜åŠ¿
    value_proposition: str  # ä»·å€¼ä¸»å¼ 


@dataclass
class CompetitorAnalysis:
    """ç«å“åˆ†æ"""
    competitors: List[Dict[str, Any]]  # ç«å“åˆ—è¡¨
    strengths: List[str]  # æœ¬é¡¹ç›®ä¼˜åŠ¿
    weaknesses: List[str]  # æœ¬é¡¹ç›®åŠ£åŠ¿
    opportunities: List[str]  # å¸‚åœºæœºä¼š


@dataclass
class DistributionRecommendation:
    """å‘è¡Œæ¸ é“å»ºè®®"""
    primary_channels: List[str]  # ä¸»è¦æ¸ é“
    secondary_channels: List[str]  # æ¬¡è¦æ¸ é“
    timing_suggestion: str  # å‘è¡Œæ—¶æœºå»ºè®®
    pricing_strategy: str  # å®šä»·ç­–ç•¥å»ºè®®
```


### Market_Agent API è®¾è®¡

```python
# POST /api/wizard/market-analysis - æ‰§è¡Œå¸‚åœºåˆ†æ
class MarketAnalysisRequest(BaseModel):
    project_id: str

class MarketAnalysisResponse(BaseModel):
    task_id: str
    status: str
    agent: str = "market_agent"

# GET /api/wizard/market-analysis/{project_id} - è·å–å¸‚åœºåˆ†æç»“æœ
class MarketAnalysisDetailResponse(BaseModel):
    project_id: str
    analysis: MarketAnalysisResult
    generated_at: datetime
    is_dynamic: bool = True
```

### MarketAnalysisPanel å‰ç«¯ç»„ä»¶

```typescript
interface MarketAnalysisPanelProps {
  projectId: string;
  analysis: MarketAnalysisResult | null;
  isLoading: boolean;
  onRefresh: () => void;
}

// æ˜¾ç¤ºç¤ºä¾‹ï¼š
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  ğŸ“Š å¸‚åœºåˆ†ææŠ¥å‘Š                              [åˆ·æ–°]        â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚  ğŸ¯ ç›®æ ‡å—ä¼—                                                â”‚
// â”‚  â”œâ”€â”€ ä¸»è¦å—ä¼—ï¼š18-35å²ï¼Œç”·æ€§ä¸ºä¸»ï¼Œç§‘å¹»çˆ±å¥½è€…               â”‚
// â”‚  â””â”€â”€ æ¬¡è¦å—ä¼—ï¼š35-50å²ï¼Œå®¶åº­è§‚ä¼—                           â”‚
// â”‚                                                             â”‚
// â”‚  ğŸ“ å¸‚åœºå®šä½                                                â”‚
// â”‚  â””â”€â”€ ä¸­ç­‰é¢„ç®—ç§‘å¹»çŸ­ç‰‡ï¼Œä¸»æ‰“è§†è§‰æ•ˆæœå’Œæƒ…æ„Ÿå…±é¸£              â”‚
// â”‚                                                             â”‚
// â”‚  ğŸ† ç«å“åˆ†æ                                                â”‚
// â”‚  â””â”€â”€ åŒç±»å‹ä½œå“ï¼šã€ŠXXXã€‹ã€ŠYYYã€‹ï¼Œæœ¬é¡¹ç›®ä¼˜åŠ¿ï¼š...           â”‚
// â”‚                                                             â”‚
// â”‚  ğŸ“º å‘è¡Œå»ºè®®                                                â”‚
// â”‚  â””â”€â”€ æ¨èæ¸ é“ï¼šBç«™ã€YouTubeã€ç”µå½±èŠ‚                        â”‚
// â”‚                                                             â”‚
// â”‚  âš¡ åŠ¨æ€æ•°æ® | ç”Ÿæˆæ—¶é—´ï¼š2025-12-25 10:30                  â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## è¡¥å……è®¾è®¡ï¼šSystem_Agent å¯¼å‡ºå‰æ ¡éªŒï¼ˆReq 12ï¼‰

### System_Agent æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   System_Agent å¯¼å‡ºå‰æ ¡éªŒæµç¨‹                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  ç”¨æˆ·ç‚¹å‡»"å¯¼å‡º"                                                     â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 1: æ ‡ç­¾ä¸€è‡´æ€§æ£€æŸ¥                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æ£€æŸ¥è§’è‰²æ ‡ç­¾æ˜¯å¦çŸ›ç›¾ï¼ˆå¦‚ï¼šåˆç”·åˆå¥³ï¼‰                    â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æ£€æŸ¥åœºæ™¯æ ‡ç­¾æ˜¯å¦çŸ›ç›¾ï¼ˆå¦‚ï¼šåˆå®¤å†…åˆå®¤å¤–ï¼‰                â”‚   â”‚
â”‚  â”‚  â””â”€â”€ æ£€æŸ¥å‰§æœ¬ä¸ç¾æœ¯æ ‡ç­¾æ˜¯å¦å†²çª                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 2: ç´ æåŒ¹é…åº¦æ£€æŸ¥                                      â”‚   â”‚
â”‚  â”‚  â””â”€â”€ é¢„æœç´¢å½“å‰æ ‡ç­¾ä¸è§†é¢‘ç´ æ TAG çš„åŒ¹é…ç™¾åˆ†æ¯”               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 3: API å¥åº·æ£€æŸ¥                                        â”‚   â”‚
â”‚  â”‚  â””â”€â”€ æ£€æŸ¥å‰åç«¯æ¥å£æ˜¯å¦æ­£å¸¸                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 4: é¡µé¢æ¸²æŸ“æ£€æŸ¥                                        â”‚   â”‚
â”‚  â”‚  â””â”€â”€ æ£€æŸ¥å±•ç¤ºé¡µé¢æ˜¯å¦æœ‰ bug æˆ–æŠ¥é”™                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  æ ¡éªŒé€šè¿‡ â†’ å…è®¸å¯¼å‡º | æ ¡éªŒå¤±è´¥ â†’ æ˜¾ç¤ºé—®é¢˜åˆ—è¡¨å’Œä¿®å¤å»ºè®®           â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### System_Agent å®ç°

```python
class SystemAgent(BaseAgent):
    """ç³»ç»Ÿæ ¡éªŒ Agent - å¯¼å‡ºå‰å…¨é¢æ ¡éªŒ"""
    
    def __init__(self, agent_id: str, message_bus, milvus_store, config=None):
        super().__init__(
            agent_id=agent_id,
            agent_type=AgentType.SYSTEM,
            message_bus=message_bus,
            capabilities=["tag_consistency", "asset_matching", 
                         "api_health", "render_check"],
            config=config
        )
        self.milvus = milvus_store
    
    # çŸ›ç›¾æ ‡ç­¾è§„åˆ™å®šä¹‰
    CONFLICTING_TAGS = {
        'gender': [['ç”·', 'å¥³'], ['male', 'female']],
        'location': [['å®¤å†…', 'å®¤å¤–'], ['indoor', 'outdoor']],
        'time': [['ç™½å¤©', 'å¤œæ™š'], ['day', 'night']],
        'height': [['é«˜', 'çŸ®'], ['tall', 'short']],
        'build': [['èƒ–', 'ç˜¦'], ['fat', 'thin']],
    }
    
    async def validate_for_export(self, project_id: str) -> ValidationReport:
        """å¯¼å‡ºå‰å…¨é¢æ ¡éªŒ"""
        issues = []
        
        # 1. æ ‡ç­¾ä¸€è‡´æ€§æ£€æŸ¥
        tag_issues = await self._check_tag_consistency(project_id)
        issues.extend(tag_issues)
        
        # 2. ç´ æåŒ¹é…åº¦æ£€æŸ¥
        match_result = await self._check_asset_matching(project_id)
        if match_result.match_percentage < 50:
            issues.append(ValidationIssue(
                type='warning',
                category='asset_matching',
                message=f'ç´ æåŒ¹é…åº¦è¾ƒä½ï¼š{match_result.match_percentage}%',
                suggestion='å»ºè®®ä¸Šä¼ æ›´å¤šç›¸å…³ç´ ææˆ–è°ƒæ•´æ ‡ç­¾'
            ))
        
        # 3. API å¥åº·æ£€æŸ¥
        api_issues = await self._check_api_health()
        issues.extend(api_issues)
        
        # 4. é¡µé¢æ¸²æŸ“æ£€æŸ¥
        render_issues = await self._check_render_status(project_id)
        issues.extend(render_issues)
        
        return ValidationReport(
            project_id=project_id,
            is_valid=not any(i.type == 'error' for i in issues),
            issues=issues,
            can_export=not any(i.type == 'error' for i in issues),
            checked_at=datetime.now()
        )

    
    async def _check_tag_consistency(self, project_id: str) -> List[ValidationIssue]:
        """æ£€æŸ¥æ ‡ç­¾ä¸€è‡´æ€§"""
        issues = []
        project = await self._get_project(project_id)
        
        # æ£€æŸ¥è§’è‰²æ ‡ç­¾
        for character in project.characters:
            for category, conflict_groups in self.CONFLICTING_TAGS.items():
                for conflict_group in conflict_groups:
                    found_tags = [t for t in character.tags if t in conflict_group]
                    if len(found_tags) > 1:
                        issues.append(ValidationIssue(
                            type='error',
                            category='tag_conflict',
                            message=f'è§’è‰² "{character.name}" å­˜åœ¨çŸ›ç›¾æ ‡ç­¾ï¼š{found_tags}',
                            suggestion=f'è¯·æ£€æŸ¥å¹¶ä¿®æ­£è§’è‰²çš„{category}å±æ€§',
                            related_entity=character.name
                        ))
        
        # æ£€æŸ¥åœºæ™¯æ ‡ç­¾
        for scene in project.scenes:
            for category, conflict_groups in self.CONFLICTING_TAGS.items():
                for conflict_group in conflict_groups:
                    found_tags = [t for t in scene.tags if t in conflict_group]
                    if len(found_tags) > 1:
                        issues.append(ValidationIssue(
                            type='error',
                            category='tag_conflict',
                            message=f'åœºæ™¯ "{scene.name}" å­˜åœ¨çŸ›ç›¾æ ‡ç­¾ï¼š{found_tags}',
                            suggestion=f'è¯·æ£€æŸ¥å¹¶ä¿®æ­£åœºæ™¯çš„{category}å±æ€§',
                            related_entity=scene.name
                        ))
        
        # æ£€æŸ¥å‰§æœ¬ä¸ç¾æœ¯æ ‡ç­¾å†²çª
        script_art_conflicts = await self._check_script_art_conflicts(project)
        issues.extend(script_art_conflicts)
        
        return issues

    
    async def _check_asset_matching(self, project_id: str) -> AssetMatchResult:
        """æ£€æŸ¥ç´ æåŒ¹é…åº¦"""
        project = await self._get_project(project_id)
        all_tags = self._collect_all_tags(project)
        
        # åœ¨ Milvus ä¸­æœç´¢åŒ¹é…çš„ç´ æ
        matched_count = 0
        total_scenes = len(project.scenes)
        
        for scene in project.scenes:
            results = self.milvus.search_by_tags(scene.tags, top_k=1)
            if results:
                matched_count += 1
        
        match_percentage = (matched_count / total_scenes * 100) if total_scenes > 0 else 0
        
        return AssetMatchResult(
            total_scenes=total_scenes,
            matched_scenes=matched_count,
            match_percentage=round(match_percentage, 1)
        )
    
    async def _check_api_health(self) -> List[ValidationIssue]:
        """æ£€æŸ¥ API å¥åº·çŠ¶æ€"""
        issues = []
        endpoints = [
            '/api/wizard/parse-script',
            '/api/wizard/generate-content',
            '/api/wizard/process-assets',
            '/api/wizard/market-analysis',
        ]
        
        for endpoint in endpoints:
            try:
                # å¥åº·æ£€æŸ¥è¯·æ±‚
                response = await self._health_check(endpoint)
                if not response.ok:
                    issues.append(ValidationIssue(
                        type='error',
                        category='api_health',
                        message=f'API ç«¯ç‚¹ä¸å¯ç”¨ï¼š{endpoint}',
                        suggestion='è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ'
                    ))
            except Exception as e:
                issues.append(ValidationIssue(
                    type='error',
                    category='api_health',
                    message=f'API è¿æ¥å¤±è´¥ï¼š{endpoint}',
                    suggestion=str(e)
                ))
        
        return issues
    
    async def _check_render_status(self, project_id: str) -> List[ValidationIssue]:
        """æ£€æŸ¥é¡µé¢æ¸²æŸ“çŠ¶æ€"""
        # æ£€æŸ¥å‰ç«¯é¡µé¢æ˜¯å¦æœ‰æ¸²æŸ“é”™è¯¯
        issues = []
        # å®ç°é¡µé¢æ¸²æŸ“æ£€æŸ¥é€»è¾‘
        return issues


@dataclass
class ValidationIssue:
    """æ ¡éªŒé—®é¢˜"""
    type: str  # 'error' | 'warning' | 'info'
    category: str  # 'tag_conflict' | 'asset_matching' | 'api_health' | 'render'
    message: str
    suggestion: str
    related_entity: Optional[str] = None


@dataclass
class ValidationReport:
    """æ ¡éªŒæŠ¥å‘Š"""
    project_id: str
    is_valid: bool
    issues: List[ValidationIssue]
    can_export: bool
    checked_at: datetime


@dataclass
class AssetMatchResult:
    """ç´ æåŒ¹é…ç»“æœ"""
    total_scenes: int
    matched_scenes: int
    match_percentage: float
```

### System_Agent API è®¾è®¡

```python
# POST /api/wizard/validate-export - å¯¼å‡ºå‰æ ¡éªŒ
class ValidateExportRequest(BaseModel):
    project_id: str

class ValidateExportResponse(BaseModel):
    is_valid: bool
    can_export: bool
    issues: List[ValidationIssue]
    asset_match_percentage: float
    checked_at: datetime
```


---

## è¡¥å……è®¾è®¡ï¼šæ•°æ®æ ‡æ³¨è§„èŒƒï¼ˆReq 14ï¼‰

### æ•°æ®ç±»å‹å®šä¹‰

```python
class DataType(Enum):
    """æ•°æ®ç±»å‹æšä¸¾"""
    STATIC = "static"    # é™æ€æ•°æ®æ¡ˆä¾‹ï¼ˆæ¨¡æ¿ã€ç¤ºä¾‹ï¼‰
    DYNAMIC = "dynamic"  # åŠ¨æ€æ•°æ®ï¼ˆå®æ—¶ç”Ÿæˆã€åˆ†æç»“æœï¼‰


@dataclass
class DataAnnotation:
    """æ•°æ®æ ‡æ³¨"""
    data_type: DataType
    source: str  # æ•°æ®æ¥æº
    generated_at: Optional[datetime]  # ç”Ÿæˆæ—¶é—´ï¼ˆåŠ¨æ€æ•°æ®ï¼‰
    is_editable: bool  # æ˜¯å¦å¯ç¼–è¾‘
```

### æ•°æ®æ ‡æ³¨è§„åˆ™

| ç¯èŠ‚ | æ•°æ®ç±»å‹ | è¯´æ˜ |
|------|----------|------|
| é¡¹ç›®æ¨¡æ¿ | é™æ€ | é¢„è®¾æ¨¡æ¿ï¼Œå¯ä½œä¸ºå‚è€ƒ |
| ç¤ºä¾‹é¡¹ç›® | é™æ€ | æ¼”ç¤ºç”¨ä¾‹ï¼Œæ ‡è®°ä¸º"ç¤ºä¾‹" |
| Script_Agent è§£æ | åŠ¨æ€ | åŸºäºç”¨æˆ·å‰§æœ¬å®æ—¶è§£æ |
| Art_Agent åˆ†ç±» | åŠ¨æ€ | åŸºäºç”¨æˆ·ç´ æå®æ—¶åˆ†ç±» |
| Market_Agent åˆ†æ | åŠ¨æ€ | åŸºäºé¡¹ç›®æ•°æ®å®æ—¶åˆ†æ |
| System_Agent æ ¡éªŒ | åŠ¨æ€ | åŸºäºé¡¹ç›®æ•°æ®å®æ—¶æ ¡éªŒ |
| Director_Agent å®¡æ ¸ | åŠ¨æ€ | åŸºäºä¸Šä¸‹æ–‡å®æ—¶å®¡æ ¸ |


### DataTypeIndicator å‰ç«¯ç»„ä»¶

```typescript
interface DataTypeIndicatorProps {
  dataType: 'static' | 'dynamic';
  source?: string;
  generatedAt?: Date;
}

// é™æ€æ•°æ®æ˜¾ç¤ºç¤ºä¾‹ï¼š
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  ğŸ“‹ çŸ­ç‰‡æ¨¡æ¿                        â”‚
// â”‚  â”œâ”€â”€ æ—¶é•¿ï¼š5-30åˆ†é’Ÿ                 â”‚
// â”‚  â”œâ”€â”€ ç”»å¹…ï¼š16:9                     â”‚
// â”‚  â””â”€â”€ å¸§ç‡ï¼š24fps                    â”‚
// â”‚                                      â”‚
// â”‚  ğŸ“Œ é™æ€æ¡ˆä¾‹ | ä»…ä¾›å‚è€ƒ              â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// åŠ¨æ€æ•°æ®æ˜¾ç¤ºç¤ºä¾‹ï¼š
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  ğŸ“Š å¸‚åœºåˆ†ææŠ¥å‘Š                    â”‚
// â”‚  â”œâ”€â”€ ç›®æ ‡å—ä¼—ï¼š18-35å²              â”‚
// â”‚  â”œâ”€â”€ å¸‚åœºå®šä½ï¼šä¸­ç­‰é¢„ç®—ç§‘å¹»çŸ­ç‰‡     â”‚
// â”‚  â””â”€â”€ æ¨èæ¸ é“ï¼šBç«™ã€YouTube         â”‚
// â”‚                                      â”‚
// â”‚  âš¡ åŠ¨æ€æ•°æ® | 2025-12-25 10:30     â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

const DataTypeIndicator: React.FC<DataTypeIndicatorProps> = ({
  dataType,
  source,
  generatedAt
}) => {
  if (dataType === 'static') {
    return (
      <div className="data-indicator static">
        <span className="icon">ğŸ“Œ</span>
        <span className="label">é™æ€æ¡ˆä¾‹</span>
        <span className="hint">ä»…ä¾›å‚è€ƒ</span>
      </div>
    );
  }
  
  return (
    <div className="data-indicator dynamic">
      <span className="icon">âš¡</span>
      <span className="label">åŠ¨æ€æ•°æ®</span>
      {generatedAt && (
        <span className="time">{formatDateTime(generatedAt)}</span>
      )}
    </div>
  );
};
```


### æ•°æ®æ ‡æ³¨æœåŠ¡

```python
class DataAnnotationService:
    """æ•°æ®æ ‡æ³¨æœåŠ¡ - ç®¡ç†æ•°æ®ç±»å‹æ ‡æ³¨"""
    
    @staticmethod
    def annotate_static(data: Any, source: str = "template") -> AnnotatedData:
        """æ ‡æ³¨ä¸ºé™æ€æ•°æ®"""
        return AnnotatedData(
            data=data,
            annotation=DataAnnotation(
                data_type=DataType.STATIC,
                source=source,
                generated_at=None,
                is_editable=False
            )
        )
    
    @staticmethod
    def annotate_dynamic(data: Any, source: str, generated_at: datetime = None) -> AnnotatedData:
        """æ ‡æ³¨ä¸ºåŠ¨æ€æ•°æ®"""
        return AnnotatedData(
            data=data,
            annotation=DataAnnotation(
                data_type=DataType.DYNAMIC,
                source=source,
                generated_at=generated_at or datetime.now(),
                is_editable=True
            )
        )
    
    @staticmethod
    def validate_dynamic_requirement(data: AnnotatedData, context: str) -> bool:
        """éªŒè¯åŠ¨æ€æ•°æ®è¦æ±‚ï¼ˆåæœŸåˆ†æç¯èŠ‚å¿…é¡»ä½¿ç”¨åŠ¨æ€æ•°æ®ï¼‰"""
        DYNAMIC_REQUIRED_CONTEXTS = [
            'market_analysis',
            'system_validation',
            'director_review',
            'export_check'
        ]
        
        if context in DYNAMIC_REQUIRED_CONTEXTS:
            return data.annotation.data_type == DataType.DYNAMIC
        return True


@dataclass
class AnnotatedData:
    """å¸¦æ ‡æ³¨çš„æ•°æ®"""
    data: Any
    annotation: DataAnnotation
```

---

## è®¾è®¡æ–‡æ¡£å®¡æ ¸æ¸…å•ï¼ˆæ›´æ–°ï¼‰

- [x] é—®é¢˜åˆ†æå®Œæˆï¼ˆP0-1 åˆ° P0-7ï¼‰
- [x] æ¶æ„è®¾è®¡å®Œæˆï¼ˆç®€åŒ– MVP æ–¹æ¡ˆï¼‰
- [x] ç»„ä»¶æ¥å£å®šä¹‰å®Œæˆ
- [x] æ•°æ®æ¨¡å‹å®šä¹‰å®Œæˆ
- [x] é”™è¯¯å¤„ç†ç­–ç•¥å®šä¹‰å®Œæˆ
- [x] ç´ æé¢„å¤„ç†ç®¡é“è®¾è®¡å®Œæˆ
- [x] Storyboard_Agent è®¾è®¡å®Œæˆ
- [x] Correctness Properties å®šä¹‰å®Œæˆï¼ˆ10 ä¸ªæ ¸å¿ƒå±æ€§ï¼‰
- [x] æµ‹è¯•ç­–ç•¥å®šä¹‰å®Œæˆï¼ˆHypothesis å±æ€§æµ‹è¯•ï¼‰
- [x] **ProjectValidator ç»„ä»¶è®¾è®¡å®Œæˆï¼ˆReq 6ï¼‰**
- [x] **æ¨¡æ¿ç®¡ç† API è®¾è®¡å®Œæˆï¼ˆReq 8ï¼‰**
- [x] **Market_Agent è®¾è®¡å®Œæˆï¼ˆReq 11ï¼‰**
- [x] **System_Agent è®¾è®¡å®Œæˆï¼ˆReq 12ï¼‰**
- [x] **æ•°æ®æ ‡æ³¨è§„èŒƒè®¾è®¡å®Œæˆï¼ˆReq 14ï¼‰**


---

## å‰§æœ¬æ•°æ®åˆ°é¡¹ç›®èµ„äº§çš„è‡ªåŠ¨æ‰“é€šè®¾è®¡ï¼ˆæ–°å¢ 2025-12-29ï¼‰

> **éœ€æ±‚æ¥æº**: Requirement 18-19
> **ç›®æ ‡**: å®ç°å‰§æœ¬è§£æåçš„äººç‰©å°ä¼ å’Œåœºæ™¯æè¿°è‡ªåŠ¨è½¬æ¢ä¸ºæ ‡ç­¾ï¼Œå¹¶å…³è”åˆ°é¡¹ç›®èµ„äº§

### 1. å‰§æœ¬æ•°æ®åˆ°æ ‡ç­¾è½¬æ¢æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å‰§æœ¬æ•°æ®åˆ°é¡¹ç›®èµ„äº§è‡ªåŠ¨æ‰“é€šæ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Script_Agent å®Œæˆå‰§æœ¬è§£æ                                          â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 1: äººç‰©å°ä¼  â†’ è§’è‰²æ ‡ç­¾                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æå–å¤–è§‚æè¿°ï¼ˆèº«é«˜ã€ä½“å‹ã€å‘å‹ã€è‚¤è‰²ï¼‰                  â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æå–æœè£…é£æ ¼ï¼ˆç°ä»£/å¤è£…/åˆ¶æœï¼‰                          â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æå–æ€§æ ¼ç‰¹å¾ï¼ˆç”¨äºåŒ¹é…è¡¨æ¼”é£æ ¼ï¼‰                        â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æå–å…³è”é“å…·                                            â”‚   â”‚
â”‚  â”‚  â””â”€â”€ ç”Ÿæˆè§†è§‰æ ‡ç­¾åˆ—è¡¨                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 2: åœºæ™¯æè¿° â†’ åœºæ™¯æ ‡ç­¾                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æå–åœºæ™¯ç±»å‹ï¼ˆINT/EXTï¼‰                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æå–æ—¶é—´ï¼ˆDAY/NIGHT/DAWN/DUSKï¼‰                         â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æå–åœ°ç‚¹æè¿°                                            â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æå–æƒ…ç»ªæ°›å›´                                            â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ ç”Ÿæˆç¯å¢ƒæ ‡ç­¾åˆ—è¡¨                                        â”‚   â”‚
â”‚  â”‚  â””â”€â”€ ç”ŸæˆåŠ¨ä½œæ ‡ç­¾åˆ—è¡¨                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 3: å­˜å‚¨åˆ°é¡¹ç›®èµ„äº§åº“                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å†™å…¥ character_tags è¡¨                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å†™å…¥ scene_tags è¡¨                                      â”‚   â”‚
â”‚  â”‚  â””â”€â”€ å»ºç«‹å…³è”ç´¢å¼•                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                            â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 4: è‡ªåŠ¨ç´ æåŒ¹é…                                        â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ åŸºäºæ ‡ç­¾ç›¸ä¼¼åº¦æœç´¢                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ åŸºäºå‘é‡ç›¸ä¼¼åº¦æœç´¢                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æ··åˆæ’åºè¿”å› Top N                                      â”‚   â”‚
â”‚  â”‚  â””â”€â”€ å­˜å‚¨åˆ°é¡¹ç›®èµ„äº§å…³è”è¡¨                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. è§’è‰²æ ‡ç­¾æ•°æ®ç»“æ„

```python
@dataclass
class CharacterTags:
    """è§’è‰²æ ‡ç­¾ - ä»äººç‰©å°ä¼ è‡ªåŠ¨ç”Ÿæˆ"""
    character_id: str           # è§’è‰² ID
    character_name: str         # è§’è‰²åç§°
    project_id: str             # é¡¹ç›® ID
    
    # å¤–è§‚æè¿°
    appearance: Dict[str, str]  # {
                                #   "height": "é«˜/ä¸­ç­‰/çŸ®",
                                #   "build": "å¥å£®/æ™®é€š/çº¤ç»†",
                                #   "hair": "é»‘è‰²é•¿å‘/é‡‘è‰²çŸ­å‘/...",
                                #   "skin": "ç™½çš™/å°éº¦è‰²/...",
                                #   "age_range": "é’å¹´/ä¸­å¹´/è€å¹´"
                                # }
    
    # æœè£…é£æ ¼
    costume: str                # ç°ä»£/å¤è£…/åˆ¶æœ/ä¼‘é—²/æ­£è£…
    costume_details: List[str]  # ["è¥¿è£…", "é¢†å¸¦", "çš®é‹"]
    
    # æ€§æ ¼ç‰¹å¾ï¼ˆç”¨äºåŒ¹é…è¡¨æ¼”é£æ ¼ï¼‰
    personality: List[str]      # ["å‹‡æ•¢", "å†²åŠ¨", "æ­£ä¹‰æ„Ÿå¼º"]
    
    # å…³è”é“å…·
    props: List[str]            # ["åˆ€", "æ‰‹æœº", "çœ¼é•œ"]
    
    # è§†è§‰æ ‡ç­¾ï¼ˆç”¨äºç´ æåŒ¹é…ï¼‰
    visual_tags: List[str]      # ["ç”·æ€§", "é»‘å‘", "ç°ä»£è£…", "æˆ˜æ–—"]
    
    # å…ƒæ•°æ®
    source: str                 # "script_agent" | "user_input"
    confidence: float           # ç½®ä¿¡åº¦ (0-1)
    created_at: datetime
    updated_at: datetime
```

### 3. åœºæ™¯æ ‡ç­¾æ•°æ®ç»“æ„

```python
@dataclass
class SceneTags:
    """åœºæ™¯æ ‡ç­¾ - ä»åœºæ™¯æè¿°è‡ªåŠ¨ç”Ÿæˆ"""
    scene_id: str               # åœºæ¬¡ ID
    scene_number: int           # åœºæ¬¡ç¼–å·
    project_id: str             # é¡¹ç›® ID
    
    # åŸºç¡€ä¿¡æ¯
    scene_type: str             # INT | EXT | INT-EXT
    time_of_day: str            # DAY | NIGHT | DAWN | DUSK
    location: str               # åœ°ç‚¹æè¿°
    
    # æƒ…ç»ªæ°›å›´
    mood: str                   # TENSE | SAD | HAPPY | CALM | HORROR | ROMANTIC | EPIC
    
    # ç¯å¢ƒæ ‡ç­¾
    environment_tags: List[str] # ["åŸå¸‚", "è¡—é“", "å¤œæ™¯", "éœ“è™¹ç¯"]
    
    # åŠ¨ä½œæ ‡ç­¾
    action_tags: List[str]      # ["è¿½é€", "å¯¹è¯", "æ‰“æ–—"]
    
    # è§’è‰²å‡ºåœº
    characters_present: List[str]  # å‡ºåœºè§’è‰² ID åˆ—è¡¨
    
    # å…ƒæ•°æ®
    source: str                 # "script_agent" | "user_input"
    confidence: float           # ç½®ä¿¡åº¦ (0-1)
    created_at: datetime
    updated_at: datetime
```

### 4. é¡¹ç›®èµ„äº§å…³è”è¡¨è®¾è®¡

```python
@dataclass
class ProjectAssetAssociation:
    """é¡¹ç›®èµ„äº§å…³è” - å­˜å‚¨æ ‡ç­¾åˆ°ç´ æçš„åŒ¹é…ç»“æœ"""
    id: str                     # å…³è” ID
    project_id: str             # é¡¹ç›® ID
    
    # æ¥æºä¿¡æ¯
    source_type: str            # CHARACTER | SCENE
    source_id: str              # è§’è‰² ID æˆ– åœºæ¬¡ ID
    
    # åŒ¹é…çš„ç´ æ
    asset_id: str               # ç´ æ ID
    asset_type: str             # VIDEO | IMAGE | AUDIO
    
    # åŒ¹é…ä¿¡æ¯
    match_score: float          # åŒ¹é…åˆ†æ•° (0-1)
    match_reason: str           # åŒ¹é…åŸå› æè¿°
    match_tags: List[str]       # åŒ¹é…çš„æ ‡ç­¾åˆ—è¡¨
    
    # ç”¨æˆ·æ“ä½œ
    is_manual: bool             # æ˜¯å¦æ‰‹åŠ¨å…³è”
    is_confirmed: bool          # æ˜¯å¦å·²ç¡®è®¤
    is_rejected: bool           # æ˜¯å¦å·²æ‹’ç»
    
    # å…ƒæ•°æ®
    created_at: datetime
    updated_at: datetime
```

### 5. æ ‡ç­¾ç”ŸæˆæœåŠ¡è®¾è®¡

```python
class ScriptToTagsService:
    """å‰§æœ¬æ•°æ®åˆ°æ ‡ç­¾è½¬æ¢æœåŠ¡"""
    
    def __init__(self, llm_adapter: AgentLLMAdapter):
        self.llm = llm_adapter
    
    async def generate_character_tags(
        self, 
        character_name: str, 
        character_bio: str,
        script_context: str
    ) -> CharacterTags:
        """ä»äººç‰©å°ä¼ ç”Ÿæˆè§’è‰²æ ‡ç­¾"""
        prompt = f"""
        è¯·åˆ†æä»¥ä¸‹äººç‰©å°ä¼ ï¼Œæå–è§’è‰²çš„è§†è§‰ç‰¹å¾å’Œæ ‡ç­¾ï¼š
        
        è§’è‰²åç§°ï¼š{character_name}
        äººç‰©å°ä¼ ï¼š{character_bio}
        å‰§æœ¬ä¸Šä¸‹æ–‡ï¼š{script_context}
        
        è¯·è¿”å› JSON æ ¼å¼ï¼š
        {{
            "appearance": {{"height": "...", "build": "...", "hair": "...", "skin": "...", "age_range": "..."}},
            "costume": "...",
            "costume_details": [...],
            "personality": [...],
            "props": [...],
            "visual_tags": [...]
        }}
        """
        result = await self.llm.generate(prompt, response_format="json")
        return CharacterTags(**result, character_name=character_name)
    
    async def generate_scene_tags(
        self,
        scene_number: int,
        scene_heading: str,
        scene_description: str,
        scene_action: str
    ) -> SceneTags:
        """ä»åœºæ™¯æè¿°ç”Ÿæˆåœºæ™¯æ ‡ç­¾"""
        prompt = f"""
        è¯·åˆ†æä»¥ä¸‹åœºæ™¯ä¿¡æ¯ï¼Œæå–åœºæ™¯çš„è§†è§‰ç‰¹å¾å’Œæ ‡ç­¾ï¼š
        
        åœºæ¬¡ç¼–å·ï¼š{scene_number}
        åœºæ™¯æ ‡é¢˜ï¼š{scene_heading}
        åœºæ™¯æè¿°ï¼š{scene_description}
        åŠ¨ä½œæè¿°ï¼š{scene_action}
        
        è¯·è¿”å› JSON æ ¼å¼ï¼š
        {{
            "scene_type": "INT|EXT|INT-EXT",
            "time_of_day": "DAY|NIGHT|DAWN|DUSK",
            "location": "...",
            "mood": "TENSE|SAD|HAPPY|CALM|HORROR|ROMANTIC|EPIC",
            "environment_tags": [...],
            "action_tags": [...]
        }}
        """
        result = await self.llm.generate(prompt, response_format="json")
        return SceneTags(**result, scene_number=scene_number)
```

### 6. è‡ªåŠ¨ç´ æåŒ¹é…æœåŠ¡è®¾è®¡

```python
class AssetMatchingService:
    """è‡ªåŠ¨ç´ æåŒ¹é…æœåŠ¡"""
    
    def __init__(self, search_service: SearchService, vector_store: VectorStore):
        self.search = search_service
        self.vector_store = vector_store
    
    async def match_assets_for_character(
        self,
        character_tags: CharacterTags,
        top_k: int = 10
    ) -> List[ProjectAssetAssociation]:
        """ä¸ºè§’è‰²åŒ¹é…ç´ æ"""
        # 1. æ„å»ºæœç´¢æŸ¥è¯¢
        search_tags = character_tags.visual_tags
        search_text = f"{character_tags.character_name} {' '.join(character_tags.personality)}"
        
        # 2. æ ‡ç­¾æœç´¢
        tag_results = await self.search.search_by_tags(search_tags, top_k=20)
        
        # 3. å‘é‡æœç´¢
        query_embedding = await self.vector_store.embed_text(search_text)
        vector_results = await self.vector_store.search(query_embedding, top_k=20)
        
        # 4. æ··åˆæ’åº
        merged = self._merge_results(tag_results, vector_results)[:top_k]
        
        # 5. åˆ›å»ºå…³è”è®°å½•
        associations = []
        for result in merged:
            associations.append(ProjectAssetAssociation(
                source_type="CHARACTER",
                source_id=character_tags.character_id,
                asset_id=result.asset_id,
                match_score=result.score,
                match_reason=self._generate_match_reason(result, character_tags),
                match_tags=result.matched_tags
            ))
        
        return associations
    
    async def match_assets_for_scene(
        self,
        scene_tags: SceneTags,
        top_k: int = 10
    ) -> List[ProjectAssetAssociation]:
        """ä¸ºåœºæ™¯åŒ¹é…ç´ æ"""
        # ç±»ä¼¼è§’è‰²åŒ¹é…é€»è¾‘
        pass
    
    def _merge_results(self, tag_results, vector_results) -> List:
        """æ··åˆæ’åºç»“æœ"""
        # ä½¿ç”¨ RRF (Reciprocal Rank Fusion) æˆ–åŠ æƒå¹³å‡
        pass
    
    def _generate_match_reason(self, result, tags) -> str:
        """ç”ŸæˆåŒ¹é…åŸå› æè¿°"""
        matched = result.matched_tags
        return f"åŒ¹é…æ ‡ç­¾: {', '.join(matched[:3])}"
```

### 7. æ ‡ç­¾åˆ°ç´ æå…³è” API

```python
# ç”Ÿæˆè§’è‰²æ ‡ç­¾
POST /api/wizard/generate-character-tags
{
    "project_id": "xxx",
    "character_id": "char_001",
    "character_name": "å¼ ä¸‰",
    "character_bio": "ä¸€ä¸ªå‹‡æ•¢çš„å¹´è½»äºº..."
}

# å“åº”
{
    "character_tags": {
        "character_id": "char_001",
        "appearance": {...},
        "costume": "ç°ä»£ä¼‘é—²",
        "visual_tags": ["ç”·æ€§", "é’å¹´", "é»‘å‘", "ç°ä»£è£…"]
    },
    "matched_assets": [
        {
            "asset_id": "asset_001",
            "match_score": 0.85,
            "match_reason": "åŒ¹é…æ ‡ç­¾: ç”·æ€§, é’å¹´, ç°ä»£è£…"
        }
    ]
}

# ç”Ÿæˆåœºæ™¯æ ‡ç­¾
POST /api/wizard/generate-scene-tags
{
    "project_id": "xxx",
    "scene_id": "scene_001",
    "scene_heading": "INT. å’–å•¡å… - æ—¥",
    "scene_description": "ä¸€å®¶æ¸©é¦¨çš„å’–å•¡å…..."
}

# æ‰¹é‡ç”Ÿæˆå¹¶åŒ¹é…
POST /api/wizard/batch-generate-tags
{
    "project_id": "xxx",
    "generate_character_tags": true,
    "generate_scene_tags": true,
    "auto_match_assets": true
}

# æ‰‹åŠ¨è°ƒæ•´å…³è”
PUT /api/wizard/asset-association/{association_id}
{
    "is_confirmed": true,
    "is_rejected": false
}

# é‡æ–°åŒ¹é…
POST /api/wizard/rematch-assets
{
    "project_id": "xxx",
    "source_type": "CHARACTER",  # æˆ– "SCENE" æˆ– "ALL"
    "source_id": "char_001"      # å¯é€‰ï¼Œä¸å¡«åˆ™åŒ¹é…æ‰€æœ‰
}
```

### 8. æ•°æ®åº“è¿ç§»

```python
# migrations/010_add_script_to_asset_tables.py

def upgrade():
    # è§’è‰²æ ‡ç­¾è¡¨
    op.create_table(
        'character_tags',
        sa.Column('id', sa.String, primary_key=True),
        sa.Column('character_id', sa.String, nullable=False),
        sa.Column('character_name', sa.String, nullable=False),
        sa.Column('project_id', sa.String, nullable=False),
        sa.Column('appearance', sa.JSON),
        sa.Column('costume', sa.String),
        sa.Column('costume_details', sa.JSON),
        sa.Column('personality', sa.JSON),
        sa.Column('props', sa.JSON),
        sa.Column('visual_tags', sa.JSON),
        sa.Column('source', sa.String),
        sa.Column('confidence', sa.Float),
        sa.Column('created_at', sa.DateTime),
        sa.Column('updated_at', sa.DateTime),
    )
    
    # åœºæ™¯æ ‡ç­¾è¡¨
    op.create_table(
        'scene_tags',
        sa.Column('id', sa.String, primary_key=True),
        sa.Column('scene_id', sa.String, nullable=False),
        sa.Column('scene_number', sa.Integer),
        sa.Column('project_id', sa.String, nullable=False),
        sa.Column('scene_type', sa.String),
        sa.Column('time_of_day', sa.String),
        sa.Column('location', sa.String),
        sa.Column('mood', sa.String),
        sa.Column('environment_tags', sa.JSON),
        sa.Column('action_tags', sa.JSON),
        sa.Column('characters_present', sa.JSON),
        sa.Column('source', sa.String),
        sa.Column('confidence', sa.Float),
        sa.Column('created_at', sa.DateTime),
        sa.Column('updated_at', sa.DateTime),
    )
    
    # é¡¹ç›®èµ„äº§å…³è”è¡¨
    op.create_table(
        'project_asset_associations',
        sa.Column('id', sa.String, primary_key=True),
        sa.Column('project_id', sa.String, nullable=False),
        sa.Column('source_type', sa.String, nullable=False),
        sa.Column('source_id', sa.String, nullable=False),
        sa.Column('asset_id', sa.String, nullable=False),
        sa.Column('asset_type', sa.String),
        sa.Column('match_score', sa.Float),
        sa.Column('match_reason', sa.String),
        sa.Column('match_tags', sa.JSON),
        sa.Column('is_manual', sa.Boolean, default=False),
        sa.Column('is_confirmed', sa.Boolean, default=False),
        sa.Column('is_rejected', sa.Boolean, default=False),
        sa.Column('created_at', sa.DateTime),
        sa.Column('updated_at', sa.DateTime),
    )
    
    # åˆ›å»ºç´¢å¼•
    op.create_index('idx_character_tags_project', 'character_tags', ['project_id'])
    op.create_index('idx_scene_tags_project', 'scene_tags', ['project_id'])
    op.create_index('idx_asset_assoc_project', 'project_asset_associations', ['project_id'])
    op.create_index('idx_asset_assoc_source', 'project_asset_associations', ['source_type', 'source_id'])
```
