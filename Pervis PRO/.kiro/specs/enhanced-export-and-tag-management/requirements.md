# PreVis PRO 增强导出和标签管理系统 - 需求文档

## 简介

PreVis PRO需要增强其导出功能和标签管理系统，以支持更专业的工作流程。本文档定义了剧本文档导出、BeatBoard图片导出、以及视频标签可视化管理的完整需求。

## 术语表

- **PreVis PRO**: 导演的智能创意助手系统
- **BeatBoard**: 剧本节拍可视化面板，展示剧本的情节节奏和视觉元素
- **标签系统**: 用于描述视频内容的多维度标签体系（场景、情绪、动作、摄影等）
- **向量关联度**: 基于语义向量计算的内容相似度分数
- **层级关系**: 标签之间的父子或包含关系
- **关联度权重**: 标签与视频内容的匹配程度数值

## 需求

### 需求 1: 剧本文档导出功能

**用户故事**: 作为导演或制片人，我希望能够将剧本导出为专业的文档格式，以便与团队分享和打印。

#### 验收标准

1. WHEN 用户选择导出剧本 THEN 系统应提供DOC和PDF两种格式选项
2. WHEN 用户选择DOC格式导出 THEN 系统应生成包含完整剧本内容、Beat信息和标签的DOCX文件
3. WHEN 用户选择PDF格式导出 THEN 系统应生成格式化的PDF文档，保持专业的排版和样式
4. WHEN 导出文档时 THEN 系统应包含项目元数据（标题、创建日期、Beat数量等）
5. WHEN 导出文档时 THEN 系统应保留剧本的结构层次（场景、Beat、标签分类）
6. WHEN 导出完成 THEN 系统应提供下载链接或自动下载文件
7. WHEN 导出失败 THEN 系统应显示清晰的错误信息并提供重试选项

### 需求 2: BeatBoard图片导出功能

**用户故事**: 作为导演，我希望能够将BeatBoard导出为图片格式，以便在演示和讨论中使用。

#### 验收标准

1. WHEN 用户在BeatBoard页面选择导出 THEN 系统应提供PNG和JPG格式选项
2. WHEN 用户选择导出整个BeatBoard THEN 系统应生成包含所有Beat的完整可视化图片
3. WHEN 用户选择导出单个Beat THEN 系统应生成该Beat的独立图片
4. WHEN 导出图片时 THEN 系统应保持高分辨率（至少1920x1080）以确保打印质量
5. WHEN 导出图片时 THEN 系统应包含Beat的关键信息（标题、标签、情绪曲线等）
6. WHEN 导出图片时 THEN 系统应支持自定义图片尺寸和质量设置
7. WHEN 导出完成 THEN 系统应自动下载图片文件

### 需求 3: 视频标签可视化管理界面

**用户故事**: 作为内容管理员，我希望能够可视化地查看和调整视频标签的关联关系，以优化搜索结果的准确性。

#### 验收标准

1. WHEN 用户打开标签管理界面 THEN 系统应显示所有视频及其关联的标签
2. WHEN 用户选择一个视频 THEN 系统应以可视化方式展示该视频的所有标签及其层级关系
3. WHEN 用户查看标签层级 THEN 系统应清晰显示父标签和子标签的关系（如：场景 > 城市 > 夜景）
4. WHEN 用户查看标签顺序 THEN 系统应按照重要性或相关度排序显示标签
5. WHEN 用户查看关联度 THEN 系统应显示每个标签与视频内容的匹配分数（0-1或百分比）
6. WHEN 用户调整标签层级 THEN 系统应支持拖拽方式重新组织标签的父子关系
7. WHEN 用户调整标签顺序 THEN 系统应支持拖拽方式重新排序标签
8. WHEN 用户调整关联度权重 THEN 系统应提供滑块或输入框修改权重值
9. WHEN 用户保存标签调整 THEN 系统应更新数据库并重新计算向量索引
10. WHEN 用户保存标签调整 THEN 系统应显示保存成功的确认消息

### 需求 4: 向量关联度可视化

**用户故事**: 作为系统管理员，我希望能够查看和测试搜索的向量关联度，以优化语义搜索的准确性。

#### 验收标准

1. WHEN 用户在标签管理界面输入搜索查询 THEN 系统应实时显示与查询最相关的视频及其关联度分数
2. WHEN 用户查看搜索结果 THEN 系统应以可视化方式展示向量相似度（如热力图或条形图）
3. WHEN 用户选择一个视频 THEN 系统应显示该视频与查询的详细匹配信息（哪些标签匹配、权重贡献等）
4. WHEN 用户调整标签权重 THEN 系统应实时更新搜索结果和关联度分数
5. WHEN 用户测试不同查询 THEN 系统应支持保存测试案例以便后续对比
6. WHEN 用户查看向量空间 THEN 系统应提供降维可视化（如t-SNE或PCA）展示视频在语义空间中的分布
7. WHEN 用户导出测试结果 THEN 系统应生成包含查询、结果和关联度的报告

### 需求 5: 启动器和Web端集成

**用户故事**: 作为用户，我希望能够在启动器和Web界面中方便地访问这些新功能。

#### 验收标准

1. WHEN 用户在启动器中查看项目 THEN 系统应提供"导出剧本"和"导出BeatBoard"的快捷按钮
2. WHEN 用户在启动器中点击"标签管理" THEN 系统应打开Web界面的标签管理页面
3. WHEN 用户在Web界面的项目页面 THEN 系统应显示导出选项菜单
4. WHEN 用户在Web界面的BeatBoard页面 THEN 系统应显示图片导出按钮
5. WHEN 用户在Web界面的素材库页面 THEN 系统应提供"标签管理"入口
6. WHEN 用户在标签管理界面 THEN 系统应提供返回素材库的导航链接
7. WHEN 用户执行导出操作 THEN 系统应显示进度指示器

## 非功能需求

### 性能要求

1. 剧本导出应在10秒内完成（对于100页以内的剧本）
2. BeatBoard图片导出应在5秒内完成（对于20个Beat以内）
3. 标签管理界面应在2秒内加载完成
4. 向量关联度计算应在1秒内返回结果（对于1000个视频以内）
5. 标签调整的实时预览应在500ms内响应

### 可用性要求

1. 导出功能应提供清晰的格式选择和预览
2. 标签管理界面应支持键盘快捷键操作
3. 可视化图表应支持缩放和平移
4. 所有操作应提供撤销/重做功能
5. 界面应支持中文和英文双语

### 兼容性要求

1. 导出的DOCX文件应兼容Microsoft Word 2016及以上版本
2. 导出的PDF文件应符合PDF/A标准
3. 导出的图片应支持主流图片查看器
4. 标签管理界面应支持Chrome、Firefox、Safari、Edge浏览器
5. 系统应支持Windows、macOS、Linux操作系统

## 技术约束

1. 使用Python的python-docx库生成DOCX文件
2. 使用ReportLab或WeasyPrint生成PDF文件
3. 使用Pillow或html2canvas生成图片
4. 使用React和D3.js实现可视化界面
5. 使用FastAPI提供后端API
6. 向量计算使用现有的Gemini Embedding API
7. 数据存储使用现有的SQLite数据库

## 优先级

1. **P0 (必须)**: 需求1（剧本文档导出）、需求2（BeatBoard图片导出）
2. **P1 (重要)**: 需求3（标签可视化管理）、需求5（启动器集成）
3. **P2 (可选)**: 需求4（向量关联度可视化）

## 验收测试场景

### 场景1: 导出Cyberpunk演示项目的剧本

1. 打开Cyberpunk Trailer演示项目
2. 点击"导出剧本"按钮
3. 选择PDF格式
4. 验证生成的PDF包含3个Beat的完整信息
5. 验证PDF格式专业、可打印

### 场景2: 导出BeatBoard为图片

1. 打开Cyberpunk Trailer演示项目的BeatBoard
2. 点击"导出为图片"按钮
3. 选择PNG格式，1920x1080分辨率
4. 验证生成的图片清晰、包含所有Beat信息
5. 验证图片可以在PowerPoint中正常显示

### 场景3: 调整视频标签关联度

1. 打开标签管理界面
2. 选择"城市追逐"场景的视频
3. 查看当前标签："城市"(0.95)、"夜晚"(0.92)、"追逐"(0.88)
4. 将"追逐"标签的权重从0.88调整到0.95
5. 保存更改
6. 验证搜索"追逐场面"时该视频排名提升

### 场景4: 测试向量搜索关联度

1. 打开标签管理界面的搜索测试功能
2. 输入查询："夜晚城市追逐场面"
3. 查看返回的视频列表和关联度分数
4. 验证"城市追逐"视频排名第一
5. 查看详细匹配信息，验证"夜晚"、"城市"、"追逐"标签都被匹配

## 后续扩展

1. 支持导出为Final Draft格式（.fdx）
2. 支持批量导出多个项目
3. 支持自定义导出模板
4. 支持标签的自动推荐和智能补全
5. 支持标签的版本历史和回滚
6. 支持多用户协作编辑标签
