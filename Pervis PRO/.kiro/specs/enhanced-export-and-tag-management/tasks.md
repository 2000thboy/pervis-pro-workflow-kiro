# PreVis PRO 增强导出和标签管理系统 - 实现任务

## 任务列表

- [x] 1. 数据库Schema扩展


  - 创建标签层级表、资产标签关联表、导出历史表
  - 添加数据库迁移脚本
  - 测试Schema的完整性和性能
  - _需求: 需求3, 需求4_






- [ ] 2. 文档导出服务实现
  - [ ] 2.1 实现DocumentExporter基础类
    - 创建DocumentExporter服务类

    - 实现数据加载方法
    - 添加错误处理机制
    - _需求: 需求1_

  - [ ] 2.2 实现DOCX导出功能
    - 使用python-docx生成DOCX文件

    - 实现剧本内容格式化
    - 添加Beat信息和标签表格
    - 实现文档样式和排版
    - _需求: 需求1.2_

  - [ ] 2.3 实现PDF导出功能
    - 创建Jinja2模板
    - 使用WeasyPrint生成PDF
    - 实现专业样式（字体、间距、页眉页脚）
    - 优化PDF文件大小

    - _需求: 需求1.3_


  - [ ]* 2.4 编写文档导出单元测试
    - 测试DOCX格式正确性
    - 测试PDF样式一致性
    - 测试不同选项组合

    - _需求: 需求1_

- [ ] 3. 图片导出服务实现
  - [ ] 3.1 实现ImageExporter基础类
    - 创建ImageExporter服务类

    - 实现BeatBoard数据加载
    - 添加图片生成配置
    - _需求: 需求2_

  - [ ] 3.2 实现BeatBoard HTML渲染
    - 创建BeatBoard渲染模板
    - 实现Beat可视化布局
    - 添加标签和情绪曲线显示
    - _需求: 需求2.5_

  - [x] 3.3 实现图片截图和生成




    - 集成Playwright进行截图
    - 使用Pillow调整图片尺寸和质量
    - 支持PNG和JPG格式
    - 优化图片生成性能
    - _需求: 需求2.1, 2.2, 2.6_


  - [ ]* 3.4 编写图片导出单元测试
    - 测试图片尺寸和质量
    - 测试不同格式输出
    - 测试单个和批量导出

    - _需求: 需求2_

- [ ] 4. 导出API端点实现
  - [ ] 4.1 创建导出路由
    - 实现POST /api/export/script端点
    - 实现POST /api/export/beatboard端点
    - 添加请求验证和错误处理
    - _需求: 需求1, 需求2_

  - [ ] 4.2 实现文件下载功能
    - 生成临时文件URL
    - 实现文件流式下载
    - 添加文件清理机制
    - _需求: 需求1.6, 需求2.7_

  - [ ] 4.3 添加导出历史记录
    - 保存导出记录到数据库
    - 实现导出历史查询API
    - 添加导出文件管理功能
    - _需求: 需求1, 需求2_

- [ ] 5. 标签管理服务实现
  - [ ] 5.1 实现TagManager基础类
    - 创建TagManager服务类
    - 实现标签CRUD操作
    - 添加标签层级查询方法
    - _需求: 需求3_

  - [ ] 5.2 实现标签层级管理
    - 实现标签层级树构建
    - 添加父子关系更新方法
    - 实现循环检测算法
    - 支持拖拽重新组织
    - _需求: 需求3.2, 3.3, 3.6_

  - [ ] 5.3 实现标签权重调整
    - 添加权重更新方法
    - 实现权重验证（0-1范围）
    - 支持批量权重调整
    - 触发向量索引重新计算
    - _需求: 需求3.8, 3.9_

  - [ ]* 5.4 编写标签管理单元测试
    - 测试标签层级CRUD
    - 测试循环检测
    - 测试权重调整
    - 测试批量更新事务性
    - _需求: 需求3_

- [ ] 6. 标签管理API端点实现
  - [ ] 6.1 创建标签管理路由
    - 实现GET /api/tags/{asset_id}端点
    - 实现PUT /api/tags/hierarchy端点
    - 实现PUT /api/tags/weight端点
    - 实现POST /api/tags/batch-update端点
    - _需求: 需求3_

  - [ ] 6.2 添加标签验证和错误处理
    - 验证标签ID和权重值
    - 检测层级循环
    - 返回清晰的错误信息
    - _需求: 需求3_

- [ ] 7. 向量分析服务实现
  - [ ] 7.1 实现VectorAnalyzer基础类
    - 创建VectorAnalyzer服务类
    - 集成Gemini Embedding API
    - 实现向量存储和检索
    - _需求: 需求4_

  - [ ] 7.2 实现相似度计算
    - 实现余弦相似度计算
    - 考虑标签权重调整分数
    - 实现Top-K结果排序
    - 优化计算性能
    - _需求: 需求4.1, 4.2_

  - [ ] 7.3 实现匹配解释功能
    - 分析查询关键词
    - 匹配视频标签
    - 计算标签贡献度
    - 生成可读解释文本
    - _需求: 需求4.3_

  - [ ] 7.4 实现向量空间可视化
    - 实现t-SNE降维
    - 实现PCA降维
    - 生成可视化数据
    - 优化大规模数据处理
    - _需求: 需求4.6_

  - [ ]* 7.5 编写向量分析单元测试
    - 测试相似度计算准确性
    - 测试匹配解释可读性

    - 测试降维算法正确性
    - _需求: 需求4_

- [ ] 8. 向量分析API端点实现
  - [ ] 8.1 创建向量分析路由
    - 实现POST /api/search/test端点

    - 实现POST /api/vector/similarity端点
    - 实现POST /api/vector/visualize端点
    - 实现GET /api/vector/explain端点
    - _需求: 需求4_

  - [ ] 8.2 添加搜索测试案例管理
    - 实现测试案例保存
    - 实现测试案例查询
    - 实现测试结果对比
    - _需求: 需求4.5_

- [ ] 9. 前端标签管理界面实现
  - [x] 9.1 创建标签管理页面组件

    - 实现TagManagement主组件
    - 创建视频列表组件
    - 创建标签树组件
    - 添加页面路由
    - _需求: 需求3, 需求5_

  - [ ] 9.2 实现标签可视化展示
    - 使用D3.js或React Flow展示标签树
    - 实现层级关系可视化
    - 显示标签权重和顺序
    - 添加交互式缩放和平移
    - _需求: 需求3.2, 3.3, 3.4, 3.5_


  - [ ] 9.3 实现标签拖拽编辑
    - 集成react-dnd或dnd-kit
    - 实现标签拖拽重新排序
    - 实现标签拖拽调整层级
    - 添加拖拽预览和反馈

    - _需求: 需求3.6, 3.7_

  - [ ] 9.4 实现权重调整控件
    - 创建权重滑块组件
    - 实现实时权重调整
    - 显示权重变化预览
    - 添加批量调整功能
    - _需求: 需求3.8_

  - [ ] 9.5 实现保存和撤销功能
    - 添加保存按钮和确认提示
    - 实现撤销/重做功能
    - 显示保存状态和错误

    - _需求: 需求3.9, 需求3.10_

- [ ] 10. 前端向量可视化界面实现
  - [ ] 10.1 创建搜索测试页面
    - 实现SearchTest主组件
    - 创建查询输入组件
    - 创建结果列表组件

    - _需求: 需求4_

  - [ ] 10.2 实现相似度可视化
    - 使用Chart.js或Recharts展示分数
    - 实现热力图或条形图
    - 显示标签贡献度

    - 添加交互式筛选
    - _需求: 需求4.2_

  - [ ] 10.3 实现向量空间可视化
    - 使用D3.js或Plotly展示降维结果


    - 实现2D/3D散点图
    - 添加缩放、平移、旋转
    - 显示点击详情
    - _需求: 需求4.6_

  - [ ] 10.4 实现匹配解释展示
    - 创建解释面板组件
    - 显示匹配关键词和标签
    - 展示贡献度分解
    - 生成可读解释文本
    - _需求: 需求4.3_

- [ ] 11. 启动器集成
  - [ ] 11.1 添加导出功能按钮
    - 在项目卡片添加"导出剧本"按钮
    - 在项目卡片添加"导出BeatBoard"按钮
    - 实现格式选择对话框
    - 调用后端API执行导出
    - _需求: 需求5.1_

  - [ ] 11.2 添加标签管理入口
    - 在左侧边栏添加"标签管理"按钮
    - 点击打开Web界面标签管理页面
    - 传递当前项目ID参数
    - _需求: 需求5.2_

  - [ ] 11.3 添加导出进度显示
    - 实现导出进度对话框
    - 显示导出状态和进度
    - 支持取消导出操作
    - _需求: 需求5.7_

- [ ] 12. Web界面集成
  - [ ] 12.1 添加导出菜单
    - 在项目页面添加导出下拉菜单
    - 在BeatBoard页面添加导出按钮
    - 实现导出选项对话框
    - _需求: 需求5.3, 需求5.4_

  - [ ] 12.2 添加标签管理入口
    - 在素材库页面添加"标签管理"按钮
    - 在导航栏添加标签管理链接
    - 实现页面间导航
    - _需求: 需求5.5, 需求5.6_

- [ ] 13. 集成测试
  - [ ] 13.1 端到端导出测试
    - 测试完整的剧本导出流程
    - 测试完整的BeatBoard导出流程
    - 验证导出文件的质量和格式
    - _需求: 需求1, 需求2_

  - [ ] 13.2 端到端标签管理测试
    - 测试完整的标签调整流程
    - 验证标签调整对搜索的影响
    - 测试批量操作的正确性
    - _需求: 需求3_

  - [ ] 13.3 端到端向量搜索测试
    - 测试完整的搜索测试流程
    - 验证相似度计算的准确性
    - 测试可视化的交互性
    - _需求: 需求4_

- [ ] 14. 性能优化
  - [ ] 14.1 优化导出性能
    - 优化DOCX生成速度
    - 优化PDF渲染性能
    - 优化图片生成速度
    - 添加缓存机制
    - _需求: 非功能需求_

  - [ ] 14.2 优化标签管理性能
    - 优化标签树查询
    - 优化批量更新性能
    - 添加前端虚拟滚动
    - _需求: 非功能需求_

  - [ ] 14.3 优化向量搜索性能
    - 优化相似度计算
    - 添加向量索引
    - 优化降维算法
    - 实现结果缓存
    - _需求: 非功能需求_

- [ ] 15. 文档和部署
  - [ ] 15.1 编写用户文档
    - 编写导出功能使用指南
    - 编写标签管理使用指南
    - 编写向量搜索测试指南
    - 添加常见问题解答
    - _需求: 所有需求_

  - [ ] 15.2 编写部署文档
    - 编写依赖安装指南
    - 编写配置说明
    - 编写数据库迁移指南
    - 添加故障排查指南
    - _需求: 所有需求_

  - [ ] 15.3 准备演示材料
    - 准备功能演示视频
    - 准备演示PPT
    - 准备测试数据集
    - _需求: 所有需求_

- [ ] 16. 最终验收测试
  - 使用Cyberpunk演示项目测试所有功能
  - 验证导出的文档和图片质量
  - 验证标签管理的易用性
  - 验证向量搜索的准确性
  - 收集用户反馈并改进
  - _需求: 所有需求_
