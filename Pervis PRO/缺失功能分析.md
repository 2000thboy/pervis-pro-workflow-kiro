# PreVis PRO 缺失核心功能分析

## 🎯 用户需求分析

根据反馈，PreVis PRO目前缺少以下核心功能，这些是完整PreVis工作流的关键部分：

### 1. ❌ 视频剪辑和输出功能
**当前状态**: 无  
**需求**: 
- 根据BeatBoard筛选的视频片段
- 放到时间轴上进行编辑
- 最终输出合成的视频文件

**缺失的组件**:
- 视频编辑引擎（FFmpeg集成）
- 时间轴编辑器（前端）
- 视频合成服务（后端）
- 渲染队列管理

### 2. ❌ 图片识别和图片RAG
**当前状态**: 只有视频帧分析，没有独立的图片处理  
**需求**:
- 上传和分析静态图片
- 图片内容识别（物体、场景、情绪）
- 基于图片内容的语义搜索
- 图片标签自动生成

**缺失的组件**:
- 图片上传和存储
- 图片内容分析服务（Gemini Vision）
- 图片向量化和索引
- 图片搜索API

### 3. ❌ 视频分析日志功能
**当前状态**: 有分析结果，但没有详细日志  
**需求**:
- 查看视频处理的详细日志
- 每一帧的分析结果
- 标签生成过程
- 错误和警告信息

**缺失的组件**:
- 日志记录系统
- 日志查询API
- 日志展示界面
- 分析过程可视化

### 4. ❌ 自动打标工具
**当前状态**: 标签是在视频处理时生成的，没有独立的打标工具  
**需求**:
- 手动触发视频重新分析
- 批量打标多个视频
- 自定义标签规则
- 标签质量评估

**缺失的组件**:
- 批量打标服务
- 打标任务队列
- 打标进度监控
- 标签质量评分

## 📋 功能优先级

### P0 - 核心工作流（必须实现）
1. **视频剪辑和输出** ⭐⭐⭐⭐⭐
   - 这是PreVis的核心价值
   - 没有这个功能，系统只是分析工具，不是创作工具

2. **图片识别和RAG** ⭐⭐⭐⭐
   - 扩展素材库的类型
   - 提供更丰富的创作素材

### P1 - 增强功能（重要）
3. **视频分析日志** ⭐⭐⭐
   - 帮助用户理解AI的分析过程
   - 调试和优化的重要工具

4. **自动打标工具** ⭐⭐⭐
   - 提高标签质量
   - 支持自定义工作流

## 🎬 完整的PreVis工作流

### 理想的用户旅程：

```
1. 剧本导入
   ↓
2. AI分析剧本 → 生成Beats
   ↓
3. 上传视频/图片素材
   ↓
4. AI分析素材 → 自动打标
   ↓
5. 语义搜索 → 为每个Beat推荐素材
   ↓
6. 在BeatBoard上选择素材
   ↓
7. 拖拽到时间轴编辑器 ⬅️ 【缺失】
   ↓
8. 调整时长、顺序、转场
   ↓
9. 预览效果
   ↓
10. 渲染输出最终视频 ⬅️ 【缺失】
```

**当前系统只完成了步骤1-6，缺少步骤7-10！**

## 🔧 技术实现方案

### 1. 视频剪辑和输出

#### 后端技术栈
- **FFmpeg**: 视频处理核心引擎
- **MoviePy**: Python视频编辑库
- **Celery**: 异步任务队列（渲染任务）
- **Redis**: 任务状态管理

#### 前端技术栈
- **React Timeline Editor**: 时间轴组件
- **Video.js**: 视频预览播放器
- **Fabric.js**: 画布操作（可选）

#### 核心功能
```python
# 视频编辑服务
class VideoEditor:
    def create_timeline(project_id, beats)
    def add_clip(timeline_id, asset_id, start, end)
    def apply_transition(clip1, clip2, type)
    def render_video(timeline_id, output_format)
    def get_render_progress(task_id)
```

### 2. 图片识别和RAG

#### 技术方案
- **Gemini Vision API**: 图片内容分析
- **CLIP**: 图片向量化（可选）
- **ChromaDB**: 图片向量存储

#### 核心功能
```python
# 图片处理服务
class ImageProcessor:
    def analyze_image(image_path)
    def extract_features(image_path)
    def generate_tags(image_path)
    def search_similar_images(query_image)
```

### 3. 视频分析日志

#### 数据结构
```python
class AnalysisLog:
    id: str
    asset_id: str
    timestamp: datetime
    log_type: str  # frame_analysis, tag_generation, error
    content: dict
    metadata: dict
```

#### 核心功能
```python
# 日志服务
class AnalysisLogger:
    def log_frame_analysis(asset_id, frame_num, results)
    def log_tag_generation(asset_id, tags, confidence)
    def get_logs(asset_id, filters)
    def export_logs(asset_id, format)
```

### 4. 自动打标工具

#### 核心功能
```python
# 打标服务
class AutoTagger:
    def retag_asset(asset_id, options)
    def batch_tag(asset_ids, options)
    def get_tagging_progress(task_id)
    def evaluate_tag_quality(asset_id)
```

## 📊 实现工作量估算

| 功能 | 后端开发 | 前端开发 | 测试 | 总计 |
|------|---------|---------|------|------|
| 视频剪辑和输出 | 5天 | 4天 | 2天 | 11天 |
| 图片识别和RAG | 3天 | 2天 | 1天 | 6天 |
| 视频分析日志 | 2天 | 2天 | 1天 | 5天 |
| 自动打标工具 | 2天 | 1天 | 1天 | 4天 |
| **总计** | **12天** | **9天** | **5天** | **26天** |

## 🎯 建议的实现顺序

### 阶段1: 视频剪辑核心（1-2周）
1. 实现基础的视频剪辑功能
2. 创建时间轴编辑器
3. 实现视频渲染和输出
4. 完成端到端工作流测试

### 阶段2: 图片支持（1周）
1. 添加图片上传和分析
2. 实现图片RAG搜索
3. 集成到素材库

### 阶段3: 增强功能（1周）
1. 添加分析日志查看
2. 实现自动打标工具
3. 优化用户体验

## 💡 快速原型方案

如果需要快速验证概念，可以先实现简化版本：

### 最小可行产品（MVP）
1. **简化的视频编辑**
   - 只支持剪切和拼接
   - 不支持转场和特效
   - 使用FFmpeg命令行

2. **基础图片支持**
   - 只支持单张图片上传
   - 使用Gemini Vision分析
   - 简单的标签展示

3. **日志查看**
   - 只显示最近的分析记录
   - 简单的文本展示

## 🚀 下一步行动

### 立即可做的事情：
1. **创建新的规格说明**
   - 视频编辑和输出系统
   - 图片识别和RAG系统

2. **技术调研**
   - FFmpeg Python绑定（ffmpeg-python vs MoviePy）
   - 时间轴编辑器组件选型
   - 渲染队列架构设计

3. **原型开发**
   - 简单的视频拼接功能
   - 基础的图片分析

### 需要确认的问题：
1. **视频输出格式**: MP4? MOV? 其他？
2. **视频质量**: 1080p? 4K? 可配置？
3. **渲染性能**: 本地渲染 vs 云端渲染？
4. **存储方案**: 渲染的视频存储在哪里？
5. **图片格式**: 支持哪些格式？JPG, PNG, WebP?

## 📝 总结

PreVis PRO目前是一个**优秀的分析和推荐系统**，但缺少**创作和输出能力**。

要成为完整的PreVis工具，必须实现：
1. ✅ 剧本分析（已完成）
2. ✅ 素材分析（已完成）
3. ✅ 智能推荐（已完成）
4. ❌ **视频编辑**（缺失）⭐
5. ❌ **视频输出**（缺失）⭐
6. ❌ 图片支持（缺失）
7. ❌ 分析日志（缺失）
8. ❌ 自动打标（缺失）

**建议优先实现视频编辑和输出功能，这是最核心的价值！**
