# Pervis PRO MVP 流程环节图示

> 更新时间: 2025-12-28

## 一、完整用户操作流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          用户操作流程 (前端视角)                             │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐
    │  启动器   │  一键启动.bat
    └────┬─────┘
         │
         ▼
    ┌──────────┐     ┌──────────────┐     ┌──────────────┐
    │   首页   │ ──→ │  + 新建项目   │ ──→ │  项目向导    │
    │          │     │    按钮      │     │   Step 1    │
    └──────────┘     └──────────────┘     └──────┬───────┘
                                                  │
    ┌─────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step 1: 基本信息                                                            │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  项目名称: [________________] [AI生成]                                 │  │
│  │  项目类型: [短片 ▼]                                                   │  │
│  │  Logline:  [________________] [AI生成]                                 │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                            [下一步 →]       │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step 2: 剧本导入                                                            │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  [拖拽上传] 或 [粘贴剧本]                                              │  │
│  │  [生成示例剧本] [AI智能解析]                                           │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  解析结果: 2场次 | 2角色                               [← 上一步] [下一步 →] │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step 3: 角色设定                                                            │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  [角色卡片] 小明 - 主角                                                │  │
│  │    [✨生成小传] [🖼生成人设图] [👁视觉标签]                            │  │
│  │  [角色卡片] 小红 - 配角                                                │  │
│  │    [✨生成小传] [🖼生成人设图] [👁视觉标签]                            │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                    [← 上一步] [下一步 →]    │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step 4: 场次规划                                                            │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  [场次1] INT. 咖啡馆 - 夜  时长: 60s                                   │  │
│  │    [🖼生成概念图] [👁视觉标签]                                         │  │
│  │  [场次2] EXT. 街道 - 夜    时长: 45s                                   │  │
│  │    [🖼生成概念图] [👁视觉标签]                                         │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                    [← 上一步] [下一步 →]    │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step 5: 参考资料 (可选)                                                     │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  [拖拽上传参考图片]                                                    │  │
│  │  支持: JPG/PNG/GIF/WebP                                               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  💡 此步骤可跳过                                   [← 上一步] [下一步 →]    │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step 6: 确认创建                                                            │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  项目预览:                                                             │  │
│  │  🎬 城市边缘 | 短片 | 5分钟 | 16:9 | 24fps                            │  │
│  │  ─────────────────────────────────────────────────────────────────    │  │
│  │  AI校验: ✅ 项目名称 ✅ 类型 ✅ 剧本 ✅ 角色 ✅ 场次                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                    [← 上一步] [✅ 创建项目] │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ├──────────────────────────────────────────────────────────────────────┐
    │                                                                      │
    ▼                                                                      ▼
┌─────────────────────────────────────────┐   ┌────────────────────────────────┐
│  工作流程 (继续编辑)                     │   │  保存/缓存项目 (稍后继续)       │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐   │   │  ┌────────────────────────┐   │
│  │Analysis │→│ Board   │→│Timeline │   │   │  │ 保存到项目列表          │   │
│  │剧本分析 │ │ 故事板  │ │ 时间线  │   │   │  │ GET /api/projects      │   │
│  └─────────┘ └─────────┘ └────┬────┘   │   │  │ 可随时恢复编辑          │   │
│                               │        │   │  └────────────────────────┘   │
│                               ▼        │   └────────────────────────────────┘
│                         ┌─────────┐    │
│                         │ Export  │    │
│                         │  导出   │    │
│                         └─────────┘    │
└─────────────────────────────────────────┘
```

## 二、后端API调用链

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          后端API调用链                                       │
└─────────────────────────────────────────────────────────────────────────────┘

用户操作                    前端调用                      后端API
─────────────────────────────────────────────────────────────────────────────
启动应用                    App.tsx                       GET /health
                                                          GET /api/projects

点击[新建项目]              ProjectWizard                 POST /api/wizard/draft

Step1 [AI生成]              WizardStep1                   本地Demo数据
                                                          (或 POST /api/ai/generate)

Step2 [AI解析]              WizardStep2                   POST /api/wizard/parse-script

Step3 [生成小传]            WizardStep3                   POST /api/wizard/generate-content

Step4 [生成概念图]          WizardStep4                   POST /api/image-generation/scene

Step6 [创建项目]            WizardStep6                   POST /api/wizard/create-project
                                                          ↓
                            ┌───────────────────────────────┴───────────────────────────────┐
                            │                                                               │
                            ▼                                                               ▼
                    继续工作流程                                                    保存到项目列表
                    MainWorkspace                                                   GET /api/projects
                            │
                            ▼
进入工作流程                MainWorkspace                 GET /api/projects/{id}

创建时间线                  Timeline                      POST /api/timeline/create

时间线编辑                  Timeline                      GET /api/timeline/{timeline_id}
                                                          PUT /api/timeline/{id}

导出视频                    ExportDialog                  GET /api/export/formats
                                                          POST /api/export/timeline/video
                                                          GET /api/export/timeline/video/status/{task_id}
```

## 三、API测试结果 (2025-12-28 实测)

| 环节 | API端点 | 状态 | 说明 |
|------|---------|------|------|
| 健康检查 | GET /health | ✅ 200 | 服务正常 |
| 项目列表 | GET /api/projects | ✅ 200 | 正常 |
| 创建草稿 | POST /api/wizard/draft | ✅ 200 | 正常 |
| 创建项目 | POST /api/wizard/create-project | ✅ 200 | 正常 |
| 创建时间线 | POST /api/timeline/create | ✅ 200 | 正常 |
| 查询时间线 | GET /api/timeline/{id} | ✅ 200 | 正常 |
| 导出格式 | GET /api/export/formats | ✅ 200 | 正常 |

**测试通过率: 7/7 (100%)**

## 四、MVP验证结论

### ✅ 核心功能可用

1. **项目创建向导** - 6步流程完整
2. **草稿保存** - 支持中途保存
3. **项目创建** - 可以创建新项目并保存到列表
4. **时间线管理** - 创建和查询时间线
5. **导出功能** - 支持多种格式导出
6. **AI辅助** - 支持本地Demo数据

### ⚠️ 待完善功能

1. **剧本AI解析** - 需要Ollama或Gemini服务
2. **视觉内核** - CLIP模块需要正确安装
3. **视频导出** - 需要安装FFmpeg

### 🔧 环境要求

```
必需:
├─ Python 3.10+
├─ Node.js 18+
└─ 后端依赖 (pip install -r requirements.txt)

可选 (AI功能):
├─ Ollama (本地AI)
├─ Gemini API Key
└─ FFmpeg (视频导出)
```

## 五、快速验证步骤

1. 双击 `一键启动.bat`
2. 等待浏览器打开 http://localhost:3001
3. 点击 [+ 新建项目]
4. Step1: 点击 [AI生成] 填充项目名和Logline
5. Step2: 点击 [生成示例剧本]
6. Step3-5: 查看自动识别的角色和场次
7. Step6: 点击 [创建项目]
8. 项目自动保存到列表，可随时恢复编辑

**预计时间: 3-5分钟**
