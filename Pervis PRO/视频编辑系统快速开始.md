# 视频编辑系统快速开始指南

## 📋 概述

PreVis PRO视频编辑系统已完成后端核心功能开发，包括：
- ✅ 数据库Schema（Timeline, Clip, RenderTask, ProxyFile）
- ✅ FFmpeg视频处理封装
- ✅ 时间轴和片段管理服务
- ✅ 视频渲染服务
- ✅ 代理文件服务
- ✅ 完整的REST API

## 🚀 安装和配置

### 1. 安装Python依赖

```bash
cd backend
pip install -r requirements.txt
```

### 2. 安装FFmpeg

**Windows (使用Chocolatey)**:
```bash
choco install ffmpeg
```

**或手动下载**:
1. 访问 https://ffmpeg.org/download.html
2. 下载Windows版本
3. 解压到某个目录（如 `C:\ffmpeg`）
4. 添加到系统PATH环境变量

**验证安装**:
```bash
ffmpeg -version
```

### 3. 运行数据库迁移

```bash
python backend/migrations/002_add_video_editing_tables.py upgrade
```

### 4. 测试后端功能

```bash
python test_video_editing_backend.py
```

预期输出：
```
总计: 4/5 测试通过
✅ 数据库表
✅ 时间轴服务
✅ 渲染服务
✅ 代理文件服务
```

## 📚 API使用示例

### 创建时间轴

```bash
curl -X POST http://localhost:8000/api/timeline/create \
  -H "Content-Type: application/json" \
  -d '{
    "project_id": "your-project-id",
    "name": "主时间轴"
  }'
```

### 添加片段到时间轴

```bash
curl -X POST http://localhost:8000/api/timeline/{timeline_id}/clips \
  -H "Content-Type: application/json" \
  -d '{
    "asset_id": "your-asset-id",
    "start_time": 0.0,
    "end_time": 10.0,
    "trim_start": 0.0,
    "trim_end": 10.0,
    "volume": 1.0,
    "order_index": 0
  }'
```

### 启动渲染

```bash
curl -X POST http://localhost:8000/api/render/start \
  -H "Content-Type: application/json" \
  -d '{
    "timeline_id": "your-timeline-id",
    "format": "mp4",
    "resolution": "1080p",
    "framerate": 30,
    "quality": "high"
  }'
```

### 获取渲染状态

```bash
curl http://localhost:8000/api/render/{task_id}/status
```

### 下载渲染结果

```bash
curl http://localhost:8000/api/render/{task_id}/download -o output.mp4
```

## 🔧 Python代码示例

### 使用TimelineService

```python
from backend.database import SessionLocal
from backend.services.timeline_service import TimelineService, ClipData

db = SessionLocal()
service = TimelineService(db)

# 创建时间轴
timeline = service.create_timeline(
    project_id="project-123",
    name="我的时间轴"
)

# 添加片段
clip_data = ClipData({
    'asset_id': 'asset-456',
    'start_time': 0.0,
    'end_time': 10.0,
    'trim_start': 0.0,
    'trim_end': 10.0,
    'volume': 1.0,
    'order_index': 0
})
clip = service.add_clip(timeline.id, clip_data)

# 获取时间轴
timeline_data = service.get_timeline_with_clips(timeline.id)
print(f"时间轴有 {len(timeline_data['clips'])} 个片段")

db.close()
```

### 使用RenderService

```python
from backend.database import SessionLocal
from backend.services.render_service import RenderService, RenderOptions

db = SessionLocal()
service = RenderService(db)

# 检查渲染前置条件
check = service.check_render_requirements(timeline_id)
if check['can_render']:
    # 启动渲染
    options = RenderOptions({
        'format': 'mp4',
        'resolution': '1080p',
        'framerate': 30,
        'quality': 'high'
    })
    
    task_id = service.start_render(timeline_id, options)
    print(f"渲染任务已启动: {task_id}")
    
    # 获取状态
    status = service.get_render_status(task_id)
    print(f"进度: {status['progress']}%")
else:
    print(f"无法渲染: {check['errors']}")

db.close()
```

### 使用FFmpegWrapper

```python
from backend.services.ffmpeg_wrapper import ffmpeg_wrapper

# 获取视频信息
info = ffmpeg_wrapper.get_video_info("input.mp4")
print(f"时长: {info.duration}秒")
print(f"分辨率: {info.width}x{info.height}")

# 剪切视频
ffmpeg_wrapper.trim_video(
    input_path="input.mp4",
    start=10.0,
    end=20.0,
    output_path="output.mp4"
)

# 调整音频
ffmpeg_wrapper.adjust_audio(
    input_path="input.mp4",
    output_path="output.mp4",
    volume=0.5,
    fade_in=1.0,
    fade_out=1.0
)

# 生成缩略图
ffmpeg_wrapper.generate_thumbnail(
    input_path="input.mp4",
    timestamp=5.0,
    output_path="thumb.jpg"
)
```

## 📁 目录结构

```
backend/
├── database.py                    # 数据库模型（包含新表）
├── main.py                        # FastAPI主应用（已注册新路由）
├── requirements.txt               # Python依赖
├── services/
│   ├── ffmpeg_wrapper.py         # FFmpeg封装（530行）
│   ├── proxy_service.py          # 代理文件服务（250行）
│   ├── timeline_service.py       # 时间轴服务（350行）
│   └── render_service.py         # 渲染服务（550行）
├── routers/
│   ├── timeline.py               # 时间轴API（250行）
│   └── render.py                 # 渲染API（180行）
└── migrations/
    └── 002_add_video_editing_tables.py  # 数据库迁移

storage/
├── renders/                       # 渲染输出目录
├── proxies/                       # 代理文件目录
└── temp/                          # 临时文件目录
```

## 🎯 核心功能

### 1. 时间轴管理
- 创建和管理时间轴
- 添加、更新、删除视频片段
- 片段重新排序
- 时间轴验证

### 2. 视频处理
- 视频剪切（精确到帧）
- 视频拼接
- 转场效果（fade, dissolve, wipe）
- 音频调整（音量、淡入淡出、静音）

### 3. 渲染系统
- 多种输出格式（MP4, MOV）
- 多种分辨率（720p, 1080p, 4K）
- 质量预设（low, medium, high, ultra）
- 进度追踪
- 任务管理（取消、删除）

### 4. 代理文件
- 自动检测大文件（>100MB）
- 生成低分辨率代理（480p）
- 提升编辑性能

## ⚙️ 配置选项

### 渲染质量预设

```python
QUALITY_PRESETS = {
    'low': {'crf': 28, 'preset': 'fast'},
    'medium': {'crf': 23, 'preset': 'medium'},
    'high': {'crf': 18, 'preset': 'slow'},
    'ultra': {'crf': 15, 'preset': 'slower'}
}
```

### 代理文件配置

```python
PROXY_DIR = "storage/proxies"
PROXY_RESOLUTION = "480p"
AUTO_PROXY_THRESHOLD_MB = 100  # 超过100MB自动生成代理
```

### 渲染输出配置

```python
OUTPUT_DIR = "storage/renders"
TEMP_DIR = "storage/temp"
```

## 🐛 故障排除

### FFmpeg未找到

**错误**: `FFmpeg not installed`

**解决**:
1. 确认FFmpeg已安装: `ffmpeg -version`
2. 检查PATH环境变量
3. 重启终端/IDE

### 数据库表不存在

**错误**: `no such table: timelines`

**解决**:
```bash
python backend/migrations/002_add_video_editing_tables.py upgrade
```

### 渲染失败

**错误**: `Render failed: Asset file not found`

**解决**:
1. 检查素材文件是否存在
2. 验证文件路径正确
3. 确认文件权限

### 磁盘空间不足

**错误**: `Insufficient disk space`

**解决**:
1. 清理旧的渲染文件
2. 使用代理文件编辑
3. 降低输出质量

## 📊 性能优化建议

### 1. 使用代理文件
- 大文件（>100MB）自动生成代理
- 编辑时使用代理，渲染时使用原始文件

### 2. 硬件加速
- 启用GPU加速（NVENC, VideoToolbox）
- 多核CPU并行处理

### 3. 渲染优化
- 使用合适的质量预设
- 避免不必要的重新编码
- 批量渲染多个任务

## 🔜 下一步开发

### 前端组件（待开发）
- [ ] 时间轴编辑器（React组件）
- [ ] 视频预览播放器
- [ ] 渲染对话框
- [ ] 音频波形显示
- [ ] 转场效果UI

### 高级功能（未来）
- [ ] 多轨道支持
- [ ] 色彩校正
- [ ] 视频特效
- [ ] 协作编辑
- [ ] 云渲染

## 📞 支持

如有问题，请查看：
- [设计文档](.kiro/specs/video-editing-system/design.md)
- [任务列表](.kiro/specs/video-editing-system/tasks.md)
- [实现进度](视频编辑系统实现进度.md)

---

**版本**: 0.1.0  
**状态**: 后端核心完成 ✅  
**最后更新**: 2024-12-18
